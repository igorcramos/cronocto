        // *** GERAÇÃO DO CALENDÁRIO VISUAL (v9.3 - Fix Mobile Date Loop) ***
        function generateCalendar() {
            console.log("Gerar Cronograma Visual clicado!");
            const sDStr=gId('calendar-start-date').value, eDStr=gId('calendar-end-date').value;
            const outputDiv = gId('calendar-output'); const desktopDiv = outputDiv.querySelector('.desktop-calendar'); const mobileDiv = outputDiv.querySelector('.mobile-calendar'); const placeholder = gId('calendar-placeholder');

            if(!sDStr||!eDStr){alert("Defina datas.");return} if(levas.length===0){alert("Nenhuma leva.");return} if(protocols.length===0){alert("Nenhum protocolo.");return}
            const sD=new Date(sDStr+'T12:00:00Z'), eD=new Date(eDStr+'T12:00:00Z'); if(eD<sD){alert("Data final antes da inicial.");return}
            const today=new Date(); today.setUTCHours(0,0,0,0); // Hoje (UTC) para comparação

            if(placeholder) placeholder.style.display = 'none'; desktopDiv.innerHTML = ''; mobileDiv.innerHTML = ''; desktopDiv.style.display = 'none'; mobileDiv.style.display = 'none';
            initializeLastChangeDates();
            const isMobileLayout = window.innerWidth <= MOBILE_BREAKPOINT;
            console.log("Layout mobile ativo?", isMobileLayout);

            let desktopHTML_Accum = ''; let mobileHTML_Accum = '';
            let currentMonthDate = new Date(Date.UTC(sD.getUTCFullYear(), sD.getUTCMonth(), 1));
            let loopLastChanges = {}; // Histórico de troca *DENTRO* do loop mensal

            while (currentMonthDate <= eD) { // Loop meses
                 const month = currentMonthDate.getUTCMonth(); const year = currentMonthDate.getUTCFullYear();
                 const monthName = currentMonthDate.toLocaleString('pt-BR',{month:'long',year:'numeric',timeZone:'UTC'});
                 // *** REINICIALIZA o histórico de trocas no início de CADA mês ***
                 //    Isso garante que cada layout comece com o estado correto para aquele mês
                 loopLastChanges = { ...lastMediaChangeDates };

                 // --- Geração HTML Desktop (Tabela) ---
                 let desktopMonthHTML = `<div class="calendar-month"><h3>${monthName}</h3><table class="calendar-table"><thead><tr>${diasSemana.map(d=>`<th>${d}</th>`).join('')}</tr></thead><tbody>`;
                 let firstDayOfMonthDT = new Date(Date.UTC(year, month, 1)); let startingDayDT = firstDayOfMonthDT.getUTCDay();
                 let currentDateDT = new Date(firstDayOfMonthDT); currentDateDT.setUTCDate(currentDateDT.getUTCDate() - startingDayDT);
                 let desktopDone = false;
                 while (!desktopDone) {
                     desktopMonthHTML += '<tr>';
                     for (let i = 0; i < 7; i++) {
                         const dOM=currentDateDT.getUTCDate(), cMCk=currentDateDT.getUTCMonth(), cDoW=currentDateDT.getUTCDay();
                         const iCM=cMCk===month; const iWk=cDoW===0||cDoW===6; const cDUT0=new Date(currentDateDT); cDUT0.setUTCHours(0,0,0,0); const iTd=cDUT0.getTime()===today.getTime();
                         let cCls=[]; if(!iCM)cCls.push('other-month'); if(iWk&&iCM)cCls.push('weekend'); if(iTd)cCls.push('today');
                         desktopMonthHTML += `<td class="${cCls.join(' ')}">`;
                         if (iCM) {
                             desktopMonthHTML += `<span class="day-number">${dOM}</span><div>`;
                             const cD4Diff = new Date(currentDateDT);
                             levas.forEach(lv => { const dailyInfo = getDailyLevaInfo(cD4Diff, lv, loopLastChanges); if (dailyInfo) { const { dayX, finalTask, finalMedium, dailyCollections } = dailyInfo; let levaHTML = `<div class="leva-entry" style="border-left-color:${lv.color};" title="Linhas:${lv.cellLines||'N/A'}"><div class="leva-info">${lv.id} DIA ${dayX}</div>${finalTask!=='-'?`<div class="leva-task">${finalTask}</div>`:''}${finalMedium!=='-'?`<div class="leva-medium">${finalMedium}</div>`:''}`; dailyCollections.forEach(cl=>{ if(cl) {levaHTML += `<div class="collection-info-inline" title="Coleta p/${cl.levaIds?.join(',') || '?'}: ${cl.qty || 'N/A'}"><span class="collection-icon">C</span> ${cl.exp || 'Coleta'}: ${cl.qty || 'N/A'}</div>`;} }); levaHTML += `</div>`; desktopMonthHTML += levaHTML; } });
                             desktopMonthHTML += '</div>';
                         }
                         desktopMonthHTML += '</td>';
                         currentDateDT.setUTCDate(currentDateDT.getUTCDate() + 1);
                         if (currentDateDT.getUTCFullYear() > year || (currentDateDT.getUTCFullYear() === year && currentDateDT.getUTCMonth() > month)) { if (i < 6) { desktopMonthHTML += '<td class="other-month"></td>'.repeat(6 - i) } desktopDone = true; break }
                     }
                     desktopMonthHTML += '</tr>';
                 }
                 desktopMonthHTML += '</tbody></table></div>';
                 desktopHTML_Accum += desktopMonthHTML;

                 // --- Geração HTML Mobile (Divs) ---
                 let mobileMonthHTML = `<div class="calendar-month"><h3>${monthName}</h3>`;
                 // *** Garante que o loop mobile comece no dia 1 do mês CORRETO ***
                 let currentDateMB = new Date(Date.UTC(year, month, 1));
                 let monthEndDateMB = new Date(Date.UTC(year, month + 1, 0)); // Último dia do mês

                 while(currentDateMB <= monthEndDateMB) {
                     const dOM = currentDateMB.getUTCDate(), cDoW = currentDateMB.getUTCDay();
                     const iWk = cDoW === 0 || cDoW === 6; const cDUT0 = new Date(currentDateMB); cDUT0.setUTCHours(0,0,0,0); const iTd = cDUT0.getTime() === today.getTime();
                     let dayHeaderClasses = ['mobile-day-header']; if(iWk) dayHeaderClasses.push('weekend'); if(iTd) dayHeaderClasses.push('today');

                     let levasContentHTML = ''; let hasContentForDay = false;
                     const cD4Diff = new Date(currentDateMB); // Usa a data correta do loop mobile

                     levas.forEach(lv => {
                         const dailyInfo = getDailyLevaInfo(cD4Diff, lv, loopLastChanges); // Usa o estado do mês
                         if (dailyInfo) {
                             hasContentForDay = true;
                             const { dayX, finalTask, finalMedium, dailyCollections } = dailyInfo;
                             levasContentHTML += `<div class="mobile-leva-entry" style="border-left-color:${lv.color};" title="Linhas:${lv.cellLines||'N/A'}">`;
                             levasContentHTML += `<div class="leva-info">${lv.id} DIA ${dayX}</div>`;
                             if(finalTask!=='-') { levasContentHTML += `<div class="leva-task">${finalTask}</div>`; }
                             if(finalMedium!=='-') { levasContentHTML += `<div class="leva-medium">${finalMedium}</div>`; }
                             if (dailyCollections && dailyCollections.length > 0) {
                                 dailyCollections.forEach(cl=>{ if(cl) {levasContentHTML += `<div class="collection-info-inline" title="Coleta p/${cl.levaIds?.join(',') || '?'}: ${cl.qty || 'N/A'}"><span class="collection-icon">C</span> ${cl.exp || 'Coleta'}: ${cl.qty || 'N/A'}</div>`;} });
                             }
                             levasContentHTML += `</div>`; // Fecha mobile-leva-entry
                         }
                     });

                     if(hasContentForDay) {
                          mobileMonthHTML += `<div class="mobile-day-row"><div class="${dayHeaderClasses.join(' ')}">${currentDateMB.toLocaleDateString('pt-BR', {day: 'numeric', month: 'short'})} (${diasSemana[cDoW]})</div><div class="mobile-levas-container">${levasContentHTML}</div></div>`;
                     }
                     currentDateMB.setUTCDate(currentDateMB.getUTCDate() + 1); // Próximo dia do mês
                 }
                 mobileMonthHTML += `</div>`;
                 mobileHTML_Accum += mobileMonthHTML;

                 // *** ATUALIZA histórico global APÓS processar AMBOS layouts para o mês ***
                 lastMediaChangeDates = { ...loopLastChanges };

                 currentMonthDate.setUTCMonth(currentMonthDate.getUTCMonth() + 1); // Próximo mês
            } // Fim while meses

            desktopDiv.innerHTML = desktopHTML_Accum;
            mobileDiv.innerHTML = mobileHTML_Accum;
            if(isMobileLayout) { mobileDiv.style.display = 'block'; }
            else { desktopDiv.style.display = 'block'; }
         }


        // --- FUNÇÕES DE EXPORTAÇÃO ---
        // (Sem mudanças significativas)
        function downloadFile(f,c,m){const b=new Blob([c],{type:m});const u=URL.createObjectURL(b);const a=cE('a');a.href=u;a.download=f;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);}
        function escapeCsvField(f) { if(f===null||f===undefined)return'""'; const s=String(f); if(s.includes(',')||s.includes('"')||s.includes('\n'))return`"${s.replace(/"/g,'""')}"`; return s; }
        function showTasksTodayInNewTab() { /* ... (igual v9.2) ... */ const today = new Date(); const todayUTC = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate(), 12, 0, 0)); const todayStr = today.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); let tasksFound = false; initializeLastChangeDates(); let tempLastChanges = { ...lastMediaChangeDates }; console.log("[showTasksToday] Coletas Globais:", JSON.stringify(collections)); let htmlContent = ` <!DOCTYPE html><html lang="pt-BR"><head><meta charset="UTF-8"><title>Tarefas de Hoje - ${todayStr}</title><style> body { font-family: sans-serif; margin: 20px; line-height: 1.6; font-size: 14px; } .leva-section { border: 1px solid #ccc; border-radius: 8px; padding: 15px; margin-bottom: 15px; page-break-inside: avoid; } .leva-section h2 { margin: 0 0 10px 0; font-size: 1.3em; border-bottom: 1px solid #eee; padding-bottom: 8px; color: #333; } .task-item { margin-bottom: 6px; } .task-label { font-weight: bold; color: #555; } .collection-item { color: #28a745; margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 8px; font-weight: bold;} .collection-details { font-weight: normal; color: #333; margin-left: 5px;} .no-tasks { font-style: italic; color: #666; } hr { border: 0; border-top: 1px dashed #ccc; margin: 15px 0;} @media print { button { display: none; } body { margin: 0.5in; font-size: 11pt; } .leva-section { border: 1px solid #aaa; box-shadow: none; } } </style></head><body><h1>Tarefas para ${todayStr}</h1> <button onclick="window.print();">Imprimir</button><hr>`; levas.forEach(leva => { const dailyInfo = getDailyLevaInfo(todayUTC, leva, tempLastChanges); if (dailyInfo) { const { dayX, finalTask, finalMedium, dailyCollections } = dailyInfo; if (finalTask !== '-' || finalMedium !== '-' || (dailyCollections && dailyCollections.length > 0)) { tasksFound = true; htmlContent += `<div class="leva-section"><h2>Leva ${leva.id} (Dia ${dayX}) <small>(${leva.cellLines || 'N/A'})</small></h2>`; if (finalTask !== '-') htmlContent += `<div class="task-item"><span class="task-label">Tarefa:</span> ${finalTask}</div>`; if (finalMedium !== '-') htmlContent += `<div class="task-item"><span class="task-label">Meio:</span> ${finalMedium}</div>`; if(dailyCollections && dailyCollections.length > 0) { dailyCollections.forEach(col => { if(col) { htmlContent += `<div class="collection-item"><span class="task-label">Coleta:</span> <span class="collection-details">${col.exp || 'Coleta'}: ${col.qty || 'N/A'}</span></div>`; } }); } htmlContent += `</div>`; } } if (lastMediaChangeDates[leva.id] && tempLastChanges[leva.id] && tempLastChanges[leva.id].getTime() !== lastMediaChangeDates[leva.id].getTime()) { lastMediaChangeDates[leva.id] = tempLastChanges[leva.id]; } else if (!lastMediaChangeDates[leva.id] && tempLastChanges[leva.id]) { lastMediaChangeDates[leva.id] = tempLastChanges[leva.id]; } }); if (!tasksFound) { htmlContent += `<p class="no-tasks">Nenhuma tarefa ou coleta agendada para hoje.</p>`; } htmlContent += `</body></html>`; const newTab = window.open('', '_blank'); if (newTab) { newTab.document.open(); newTab.document.write(htmlContent); newTab.document.close(); newTab.focus(); } else { alert('Não foi possível abrir a nova aba. Verifique as configurações de pop-up.'); } }
        function exportDataJson() { /* ... (igual v8.3) ... */ const dE={levas,protocols,collections}; const jS=JSON.stringify(dE,null,2); downloadFile('cronograma_organoides_dados.json',jS,'application/json;charset=utf-8;'); }
        function exportScheduleCsv() { /* ... (igual v8.3) ... */ const sDS=gId('calendar-start-date').value, eDS=gId('calendar-end-date').value; if(!sDS||!eDS){alert("Defina datas p/ CSV.");return} const sD=new Date(sDS+'T12:00:00Z'), eD=new Date(eDS+'T12:00:00Z'); if(eD<sD){alert("Data final antes da inicial.");return} gId('csv-processing').style.display='inline'; setTimeout(()=>{const h=['Data','Dia_Semana','ID_Leva','Dia_X','Tipo','Descricao','Detalhes'];let cC='\uFEFF';cC+=h.map(escapeCsvField).join(',')+'\n'; initializeLastChangeDates(); let eLC={...lastMediaChangeDates}; let cD=new Date(sD); while(cD<=eD){const dS=cD.toLocaleDateString('pt-BR',{timeZone:'UTC'});const dOWS=diasSemana[cD.getUTCDay()]; levas.forEach(lv=>{const dI=getDailyLevaInfo(cD,lv,eLC);if(dI){const{dayX,finalTask,finalMedium,dailyCollections}=dI; if(finalTask!=='-'||finalMedium!=='-'){cC+=[dS,dOWS,lv.id,dayX,'Atividade',finalTask,finalMedium].map(escapeCsvField).join(',')+'\n'} dailyCollections.forEach(cl=>{cC+=[dS,dOWS,lv.id,dayX,'Coleta',cl.exp || 'Coleta',cl.qty || 'N/A'].map(escapeCsvField).join(',')+'\n'}) }}); cD.setUTCDate(cD.getUTCDate()+1);} downloadFile(`cronograma_organoides_${sDS}_a_${eDS}.csv`,cC,'text/csv;charset=utf-8;'); gId('csv-processing').style.display='none'; },50); }

        // --- INICIALIZAÇÃO ---
        // *** getDefaultProtocols ATUALIZADO para Dia 0 ***
        function getDefaultProtocols() { /* ... (igual v8.1) ... */ const dPN="Trujillo_200"; const pS=[ {protocolName:dPN,day:0,baseTask:'AGREGAR',specificMedium:'E8 + 20uM Rocki'}, {protocolName:dPN,day:1,baseTask:'Indução Neural D1 (+100uL)',specificMedium:'E8 + 2uM Dorso + 20uM SB'}, {protocolName:dPN,day:2,baseTask:'Indução Neural D2 (- + 150uL)',specificMedium:'E8 + 1uM Dorso + 10uM SB'}, {protocolName:dPN,day:3,baseTask:'Indução Neural D3 (- + 150uL)',specificMedium:'E8 + 1uM Dorso + 10uM SB'}, {protocolName:dPN,day:4,baseTask:'Transferir ~10 CtO/well // Início Meio 1',specificMedium:'Meio 1'}, {protocolName:dPN,day:5,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:6,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:7,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:8,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:9,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:10,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:11,baseTask:'Plaquear 5 CtO/Well / Início Meio 2+FGF2',specificMedium:'Meio 2 + FGF2'}, {protocolName:dPN,day:12,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:13,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:14,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:15,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:16,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:17,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:18,baseTask:'Adicionar EGF / Início Meio 2+FGF2+EGF',specificMedium:'Meio 2 + FGF2+EGF'}, {protocolName:dPN,day:19,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:20,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:21,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:22,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:23,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:24,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:25,baseTask:'Início Meio 3',specificMedium:'Meio 3'}, {protocolName:dPN,day:26,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:27,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:28,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:29,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:30,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:31,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:32,baseTask:'Organoides Formados! / Manutenção',specificMedium:meioManutencao}, ...Array.from({length:61},(_,i)=>({protocolName:dPN,day:33+i,baseTask:'-',specificMedium:'-'})) ]; return pS; }
        window.onload = () => {
             loadData(); const tFC = new Date(); const fD = new Date(tFC.getFullYear(), tFC.getMonth(), 1); const lD = new Date(tFC.getFullYear(), tFC.getMonth() + 2, 0);
             const fDt = (d) => d.toISOString().split('T')[0]; gId('calendar-start-date').value = fDt(fD); gId('calendar-end-date').value = fDt(lD);
             // Mantém exemplo v7 (Trujillo_200)
             if (levas.length === 0 && localStorage.getItem(LEVAS_KEY) === null) { levas = [ { id: 'L2', startDate: '2025-03-20', color: 'pink', protocolName: 'Trujillo_200', cellLines: '14vz, 14T' }, { id: 'L3', startDate: '2025-03-27', color: 'lightgreen', protocolName: 'Trujillo_200', cellLines: '7vz, 7T, 8vz, 8T' }, { id: 'L4', startDate: '2025-04-03', color: 'lightblue', protocolName: 'Trujillo_200', cellLines: '7vz, 7T, 8vz, 8T' }, { id: 'L5', startDate: '2025-04-22', color: 'orange', protocolName: 'Trujillo_200', cellLines: '7vz, 7T, 8vz, 8T, 14vz, 14T' } ]; sortDataArrays(); saveData(); renderAllLists(); updateCollectionLevaCheckboxes(); }
         };
    </script>

</body>
</html>
