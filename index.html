<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Cronograma v8.4 (Ajustes Finais)</title>
    <style>
        /* CSS */
        :root { --primary-color: #007bff; --secondary-color: #6c757d; --success-color: #28a745; --warning-color: #ffc107; --danger-color: #dc3545; --light-gray: #f8f9fa; --medium-gray: #e9ecef; --dark-gray: #6c757d; --text-color: #333; --border-color: #dee2e6; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; margin: 0; padding: 15px; background-color: #f4f7f6; color: var(--text-color); }
        .container { display: grid; grid-template-columns: minmax(350px, 1.5fr) 3fr; gap: 25px; max-width: 1700px; margin: auto; }
        .input-section, .output-section { background-color: #fff; border: 1px solid var(--border-color); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .input-section h2, .output-section h2 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; color: var(--text-color); font-size: 1.4em; }
        .input-section h3 { margin-top: 25px; margin-bottom: 10px; color: #555; border-bottom: 1px dashed #eee; padding-bottom: 5px; font-size: 1.15em; }
        .input-section h4 { margin-top: 15px; margin-bottom: 5px; color: #666; font-size: 1em; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; color: #444; }
        input[type="text"], input[type="date"], input[type="number"], input[type="color"], select, textarea, input[type="file"] { width: calc(100% - 18px); padding: 9px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.95em; background-color: #fff; }
        input:focus, textarea:focus, select:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2); }
        textarea { height: 60px; resize: vertical; }
        input[type="file"] { padding: 5px; }
        button { padding: 10px 15px; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px; margin-right: 5px; font-size: 0.95em; transition: background-color 0.2s ease, transform 0.1s ease; }
        button:hover { filter: brightness(110%); }
        button:active { transform: translateY(1px); }
        button.primary-btn { background-color: var(--primary-color); }
        button.edit-btn { background-color: var(--warning-color); color: #333; }
        button.remove-btn { background-color: var(--danger-color); padding: 3px 8px; font-size: 0.8em; margin: 0 0 0 5px; }
        button.save-edit-btn { background-color: var(--success-color); }
        button.clear-btn { background-color: var(--secondary-color); }
        button.export-btn { background-color: #17a2b8; }
        button.import-btn { background-color: #fd7e14; }
        .data-list { list-style: none; padding: 0; max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; margin-top: 10px; padding: 10px; background-color: #fdfdfd; }
        .data-list li { font-size: 0.9em; margin-bottom: 8px; padding: 8px; background-color: var(--light-gray); border: 1px solid #eee; border-radius: 3px; display: flex; justify-content: space-between; align-items: center; }
        .data-list li .item-content { flex-grow: 1; margin-right: 10px; line-height: 1.4; }
        .data-list li .item-actions button { margin-left: 5px; }
        .color-swatch { display: inline-block; width: 15px; height: 15px; border: 1px solid #ccc; margin-right: 8px; vertical-align: middle; border-radius: 3px; }
        .leva-checkbox-container { max-height: 120px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; border-radius: 4px; background-color: var(--light-gray); }
        .leva-checkbox-item { display: block; margin-bottom: 5px; }
        .leva-checkbox-item input[type="checkbox"] { width: auto; margin-right: 8px; vertical-align: middle; }
        .leva-checkbox-item label { display: inline; font-weight: normal; font-size: 0.95em; }
        #select-all-levas-label { display: block; margin-bottom: 8px; font-weight: bold; padding-bottom: 5px; border-bottom: 1px dashed #ccc; }
        #select-all-levas-label input { width: auto; margin-right: 5px; vertical-align: middle; }
        .calendar-output { margin-top: 20px; }
        .calendar-month { margin-bottom: 30px; }
        .calendar-month h3 { background-color: var(--medium-gray); padding: 8px; text-align: center; border-radius: 4px 4px 0 0; color: #495057; font-size: 1.1em; font-weight: 600; }
        .calendar-table { width: 100%; border-collapse: collapse; table-layout: fixed; background-color: #fff; }
        .calendar-table th, .calendar-table td {
            border: 1px solid var(--border-color); padding: 6px; text-align: left;
            vertical-align: top;
            height: 320px; /* <<< DOBRADO DE 160px */
            font-size: 0.8em; word-wrap: break-word; position: relative;
        }
        .calendar-table th { background-color: var(--light-gray); text-align: center; height: auto; font-weight: bold; }
        .day-number { position: absolute; top: 3px; right: 5px; font-weight: bold; color: var(--dark-gray); font-size: 1.1em; }
        .calendar-table td > div {
             margin-top: 20px;
             max-height: 290px; /* <<< DOBRADO E AJUSTADO (320 - padding - num) */
             overflow-y: auto; padding-right: 3px;
        }
        .leva-entry { margin-bottom: 4px; padding: 4px 6px; border-radius: 3px; border-left: 4px solid; background-color: #fff; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }
        .leva-info { font-weight: bold; font-size: 0.95em; margin-bottom: 2px;}
        .leva-task { font-style: italic; margin-bottom: 2px;}
        .leva-medium { font-size: 0.9em; color: #555; }
        .collection-info-inline { margin-top: 3px; padding: 2px 4px; border: 1px dashed var(--success-color); border-radius: 2px; background-color: #f0fff4; font-size: 0.95em; display: block; }
        .collection-icon { display: inline-block; color: var(--success-color); font-weight: bold; margin-right: 3px; }
        .weekend { background-color: var(--light-gray); }
        .other-month { background-color: var(--medium-gray); color: #adb5bd; }
        .today { border: 3px solid var(--primary-color) !important; }
        #save-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--success-color); color: white; padding: 10px 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; opacity: 0; transition: opacity 0.5s ease-in-out; }
        #save-notification.show { opacity: 1; }
        .processing-feedback { display: inline-block; margin-left: 10px; color: var(--secondary-color); font-style: italic; }
        #import-section p, #export-section p {font-size: 0.85em; color: var(--dark-gray); margin-top: 0;}
        #export-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        @media (max-width: 768px) { .container { grid-template-columns: 1fr; gap: 20px; } body { padding: 10px; font-size: 15px; } .input-section h2, .output-section h2 { font-size: 1.3em; } .input-section h3 { font-size: 1.1em; } button { font-size: 1em; padding: 12px 18px; } .calendar-table th, .calendar-table td { height: 280px;} /* <<< DOBRADO */ .day-number { font-size: 1em;} .calendar-table td > div { max-height: 250px; } } /* <<< DOBRADO e ajustado */
        @media (max-width: 480px) { button { width: 100%; margin-bottom: 10px; } .data-list li { flex-direction: column; align-items: flex-start; } .data-list li .item-actions { margin-top: 8px; } .calendar-table th, .calendar-table td { font-size: 0.7em; height: 240px;} /* <<< DOBRADO */ .day-number { font-size: 0.9em;} .calendar-table td > div { max-height: 210px; } } /* <<< DOBRADO e ajustado */
    </style>
</head>
<body>
    <div id="save-notification">Dados salvos localmente!</div>
    <h1>Gerador de Cronograma v8.4 (Altura Dobrada + Coleta Reordenada)</h1>

    <div class="container">
        <div class="input-section">
            <h2>1. Dados de Entrada</h2>
             <p style="font-size: 0.85em; color: var(--dark-gray);">As informações são salvas automaticamente no seu navegador.</p>

            <!-- IMPORTAR DADOS -->
            <div id="import-section">
                 <h3>Importar Dados</h3>
                <p>Importe de arquivos CSV (UTF-8, vírgula) ou JSON. Substitui dados atuais.</p>
                <div> <label for="leva-csv-input">Importar Levas (.csv):</label> <input type="file" id="leva-csv-input" accept=".csv" onchange="handleFileSelect(event, processLevaData)"> </div>
                <div> <label for="protocol-csv-input">Importar Protocolo(s) (.csv):</label> <input type="file" id="protocol-csv-input" accept=".csv" onchange="handleFileSelect(event, processProtocolData)"> </div>
                <div> <label for="collection-csv-input">Importar Coletas (.csv):</label> <input type="file" id="collection-csv-input" accept=".csv" onchange="handleFileSelect(event, processCollectionData)"> </div>
                <div> <label for="json-import-input">Importar Backup Completo (.json):</label> <input type="file" id="json-import-input" accept=".json,application/json" onchange="handleJsonFileSelect(event)"> </div>
            </div>
            <hr style="margin: 30px 0;">

            <!-- LEVAS (Manual) -->
            <form id="leva-form"> <input type="hidden" id="leva-edit-index"> <h3>Gerenciar Leva (Manual)</h3> <label for="leva-id">ID Leva:</label><input type="text" id="leva-id" required>
                <label for="leva-start-date">Data Início Agregação (Dia 0):</label>
                <input type="date" id="leva-start-date" required>
                <label for="leva-color">Cor:</label><input type="color" id="leva-color" value="#add8e6"><input type="text" id="leva-color-text" placeholder="Ou digite nome/hex"> <label for="leva-protocol">Nome do Protocolo:</label><input type="text" id="leva-protocol" value="Trujillo_200" required> <label for="leva-cell-lines">Linhas Celulares:</label><input type="text" id="leva-cell-lines" placeholder="Ex: 7007-1, 8799-1"> <button type="button" id="add-edit-leva-btn" class="primary-btn" onclick="addOrUpdateLeva()">Adicionar Leva</button> <button type="button" onclick="clearLevaForm()" class="clear-btn">Cancelar Edição</button> </form>
            <h4>Levas Atuais:</h4> <ul id="levas-list" class="data-list"></ul>

            <!-- PROTOCOLOS (Manual) -->
            <hr style="margin: 30px 0;">
            <form id="protocol-form"> <h3>Gerenciar Protocolo (Manual)</h3> <label for="protocol-name">Nome do Protocolo:</label><input type="text" id="protocol-name" value="Trujillo_200" required> <label for="protocol-day">Dia (relativo, 0=Agregação):</label><input type="number" id="protocol-day" required> <label for="protocol-task">Tarefa Base:</label><input type="text" id="protocol-task" placeholder="Ex: AGREGAR, -"> <label for="protocol-medium">Meio Específico (ou '-'):</label><input type="text" id="protocol-medium" placeholder="Ex: Pré-indução, -"> <button type="button" class="primary-btn" onclick="addProtocolStep()">Adicionar/Atualizar Passo</button> <p style="font-size: 0.8em; color: var(--dark-gray);">Adicionar passo p/ dia existente atualiza.</p> </form>
            <h4>Protocolos Definidos:</h4> <ul id="protocols-list" class="data-list"></ul>

             <!-- COLETAS (Manual) -->
             <hr style="margin: 30px 0;">
             <form id="collection-form"> <h3>Adicionar Coleta (Manual)</h3> <label>Para Leva(s):</label> <div class="leva-checkbox-container"> <label id="select-all-levas-label"><input type="checkbox" id="select-all-levas" onchange="toggleAllLevaCheckboxes(this.checked)"> Selecionar Todas / Nenhuma</label> <div id="collection-leva-checkboxes"><p style="color: #888; font-style: italic;">Nenhuma leva.</p></div> </div> <label for="collection-day">No Dia do Protocolo (0=Agregação):</label><input type="number" id="collection-day" required placeholder="Ex: 32, 61"> <label for="collection-qty">Quantidade/Detalhes:</label><input type="text" id="collection-qty" placeholder="Ex: 5 organoides"> <label for="collection-exp">Experimento(s):</label><textarea id="collection-exp" placeholder="Ex: RNA-seq, IF"></textarea> <button type="button" class="primary-btn" onclick="addCollection()">Adicionar Coleta</button> </form>
             <h4>Coletas Planejadas:</h4> <ul id="collections-list" class="data-list"></ul>

             <!-- CALENDÁRIO & EXPORT -->
             <hr style="margin: 30px 0;">
            <h3>Gerar Calendário & Exportar</h3>
             <label for="calendar-start-date">Data Início Calendário:</label><input type="date" id="calendar-start-date" required>
             <label for="calendar-end-date">Data Fim Calendário:</label><input type="date" id="calendar-end-date" required>
             <button type="button" class="primary-btn" onclick="generateCalendar()">Gerar Cronograma Visual</button>
             <div id="export-section">
                 <p>Exporte tarefas do dia, um backup JSON ou o cronograma completo em CSV.</p>
                 <button type="button" class="export-btn" onclick="exportTasksToday()">Tarefas de Hoje (.txt)</button>
                 <button type="button" class="export-btn" onclick="exportDataJson()">Dados (JSON)</button>
                 <button type="button" class="export-btn" onclick="exportScheduleCsv()">Cronograma (CSV)</button>
                 <span id="csv-processing" class="processing-feedback" style="display: none;">Processando CSV...</span>
             </div>
             <hr style="margin: 30px 0;">
             <button type="button" onclick="clearAllDataStored()" class="danger-btn" style="background-color: var(--danger-color);">Limpar TODOS os Dados Salvos</button>
        </div>

        <!-- ÁREA DE SAÍDA -->
        <div class="output-section">
            <h2>2. Cronograma Visual</h2>
            <div id="calendar-output" class="calendar-output">
                 <p>Use a entrada manual ou importe arquivos. Clique em "Gerar Cronograma".</p>
            </div>
        </div>
    </div>

    <script>
        // --- VARIÁVEIS GLOBAIS E CONSTANTES ---
        let levas = []; let protocols = []; let collections = []; let editingLevaIndex = null;
        let lastMediaChangeDates = {};
        const diasSemana = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sab"];
        const tarefasCriticasKeywords = ["AGREGAR", "Transferir", "Plaquear", "Organoides formados", "Indução"];
        const meioManutencao = "Meio 2 (Manutenção)";
        const preferredChangeDaysOfWeek = [1, 3, 5]; // Seg, Qua, Sex
        // Chaves localStorage (v8)
        const LEVAS_KEY = 'cronogramaLevas_v8'; const PROTOCOLS_KEY = 'cronogramaProtocols_v8'; const COLLECTIONS_KEY = 'cronogramaCollections_v8';

        // --- FUNÇÕES DE PERSISTÊNCIA ---
        function showSaveNotification() { const n=gId('save-notification');if(!n)return; n.classList.add('show'); setTimeout(()=>{n.classList.remove('show')},1500); }
        function saveData() { try { localStorage.setItem(LEVAS_KEY, JSON.stringify(levas)); localStorage.setItem(PROTOCOLS_KEY, JSON.stringify(protocols)); localStorage.setItem(COLLECTIONS_KEY, JSON.stringify(collections)); showSaveNotification(); console.log("Data saved (v8)."); } catch (e) { console.error("Error saving data:", e); alert(`Erro ao salvar dados: ${e.message}.\nVerifique o console (F12).`); }}
        function loadData() { try { const sL = localStorage.getItem(LEVAS_KEY); const sP = localStorage.getItem(PROTOCOLS_KEY); const sC = localStorage.getItem(COLLECTIONS_KEY); levas = sL ? JSON.parse(sL) : []; protocols = sP ? JSON.parse(sP) : getDefaultProtocols(); collections = sC ? JSON.parse(sC) : []; sortDataArrays(); console.log("Data loaded (v8)."); } catch (e) { console.error("Error loading data:", e); alert("Erro ao carregar dados."); levas = []; protocols = getDefaultProtocols(); collections = []; } renderAllLists(); updateCollectionLevaCheckboxes(); }
        function clearAllDataStored() { if (confirm("ATENÇÃO! Remover PERMANENTEMENTE todos os dados salvos?")) { localStorage.removeItem(LEVAS_KEY); localStorage.removeItem(PROTOCOLS_KEY); localStorage.removeItem(COLLECTIONS_KEY); levas = []; protocols = getDefaultProtocols(); collections = []; renderAllLists(); updateCollectionLevaCheckboxes(); gId('calendar-output').innerHTML = '<p>Dados limpos.</p>'; alert("Dados removidos."); }}
        function sortDataArrays() { levas.sort((a, b) => a.id.localeCompare(b.id)); protocols.sort((a, b) => { if (a.protocolName !== b.protocolName) return a.protocolName.localeCompare(b.protocolName); return a.day - b.day; }); collections.sort((a,b) => { const lA = (a.levaIds && a.levaIds.length > 0 ? a.levaIds[0] : ''); const lB = (b.levaIds && b.levaIds.length > 0 ? b.levaIds[0] : ''); const lC = lA.localeCompare(lB); return lC !== 0 ? lC : a.day - b.day; }); }
        function renderAllLists() { renderLevaList(); renderProtocolList(); renderCollectionList(); }

        // --- FUNÇÕES CRUD (Manual) ---
        function addOrUpdateLeva() { const id=gId('leva-id').value.trim(), sD=gId('leva-start-date').value, cP=gId('leva-color').value, cT=gId('leva-color-text').value.trim(), pN=gId('leva-protocol').value.trim(), cL=gId('leva-cell-lines').value.trim(); if(!id||!sD||!pN){alert("ID, Data Início, Nome Prot. obrigatórios.");return} const color=cT||cP; const nLd={id,startDate:sD,color,protocolName:pN,cellLines:cL}; if(editingLevaIndex!==null){levas[editingLevaIndex]=nLd}else{if(levas.some(l=>l.id===id)){alert(`ID "${id}" já existe.`);return}levas.push(nLd)} sortDataArrays(); saveData(); renderLevaList(); updateCollectionLevaCheckboxes(); clearLevaForm(); }
        function editLeva(i) { const l=levas[i]; gId('leva-edit-index').value=i; gId('leva-id').value=l.id; gId('leva-start-date').value=l.startDate; gId('leva-color').value=l.color.startsWith('#')?l.color:'#cccccc'; gId('leva-color-text').value=l.color; gId('leva-protocol').value=l.protocolName; gId('leva-cell-lines').value=l.cellLines; gId('add-edit-leva-btn').textContent='Salvar Edição'; gId('add-edit-leva-btn').classList.add('save-edit-btn'); editingLevaIndex=i; gId('leva-id').focus(); }
        function removeLeva(i) { if(confirm(`Remover leva "${levas[i].id}"?`)){levas.splice(i,1);saveData();renderLevaList();updateCollectionLevaCheckboxes();if(editingLevaIndex===i){clearLevaForm()}} }
        function clearLevaForm() { gId('leva-form').reset(); gId('leva-edit-index').value=''; gId('add-edit-leva-btn').textContent='Adicionar Leva'; gId('add-edit-leva-btn').classList.remove('save-edit-btn'); editingLevaIndex=null; gId('leva-protocol').value = 'Trujillo_200'; }
        function renderLevaList() { const l=gId('levas-list');l.innerHTML='';levas.forEach((lv,i)=>{const li=cE('li'),c=cE('div');c.className='item-content';c.innerHTML=`<span class="color-swatch" style="background-color:${lv.color};"></span><strong>${lv.id}</strong> (${lv.startDate}) - Prot:${lv.protocolName}<br><small><i>Linhas:${lv.cellLines||'N/A'}</i></small>`;const a=cE('div');a.className='item-actions';const eB=cE('button');eB.textContent='Editar';eB.className='edit-btn';eB.onclick=()=>editLeva(i);const rB=cE('button');rB.textContent='Remover';rB.className='remove-btn';rB.onclick=()=>removeLeva(i);a.appendChild(eB);a.appendChild(rB);li.appendChild(c);li.appendChild(a);l.appendChild(li)}) }
        function addProtocolStep() { const pN=gId('protocol-name').value.trim(),d=parseInt(gId('protocol-day').value),bT=gId('protocol-task').value.trim()||'-',sM=gId('protocol-medium').value.trim()||'-'; if(!pN||isNaN(d)){alert("Nome Protocolo e Dia obrigatórios.");return} protocols=protocols.filter(p=>!(p.protocolName===pN&&p.day===d)); protocols.push({protocolName:pN,day:d,baseTask:bT,specificMedium:sM}); sortDataArrays(); saveData(); renderProtocolList(); gId('protocol-day').value='';gId('protocol-task').value='';gId('protocol-medium').value=''; }
        function removeProtocolStep(i) { if(confirm(`Remover passo Dia ${protocols[i].day} do prot. "${protocols[i].protocolName}"?`)){protocols.splice(i,1);saveData();renderProtocolList()}}
        function renderProtocolList() { const l=gId('protocols-list');l.innerHTML='';protocols.forEach((s,i)=>{const li=cE('li'),c=cE('div');c.className='item-content';c.innerHTML=`<strong>${s.protocolName} - Dia ${s.day}</strong><br>T:${s.baseTask} <br>M:${s.specificMedium}`;const a=cE('div');a.className='item-actions';const rB=cE('button');rB.textContent='Remover';rB.className='remove-btn';rB.onclick=()=>removeProtocolStep(i);a.appendChild(rB);li.appendChild(c);li.appendChild(a);l.appendChild(li)}) }
        function addCollection() { const cbs=qSA('#collection-leva-checkboxes input:checked'); const sIds=Array.from(cbs).map(cb=>cb.value); const d=parseInt(gId('collection-day').value), q=gId('collection-qty').value.trim(), e=gId('collection-exp').value.trim(); if(sIds.length===0||isNaN(d)){alert("Selecione Leva(s) e informe o Dia.");return} const nC={levaIds:sIds,day:d,qty:q,exp:e}; collections.push(nC); sortDataArrays(); saveData(); renderCollectionList(); gId('collection-form').reset(); qSA('#collection-leva-checkboxes input').forEach(cb=>cb.checked=false); gId('select-all-levas').checked=false; }
        function removeCollection(i) { if(confirm(`Remover coleta p/ Leva(s) ${collections[i].levaIds.join(',')} Dia ${collections[i].day}?`)){collections.splice(i,1);saveData();renderCollectionList()}}
        function renderCollectionList() { const l=gId('collections-list');l.innerHTML='';collections.forEach((c,i)=>{const li=cE('li'),ct=cE('div');ct.className='item-content';ct.innerHTML=`<strong>Leva(s):${c.levaIds.join(', ')} - Dia ${c.day}</strong><br>Qtd:${c.qty||'N/A'}<br>Exp:${c.exp||'N/A'}`;const a=cE('div');a.className='item-actions';const rB=cE('button');rB.textContent='Remover';rB.className='remove-btn';rB.onclick=()=>removeCollection(i);a.appendChild(rB);li.appendChild(ct);li.appendChild(a);l.appendChild(li)}) }
        function updateCollectionLevaCheckboxes() { const c=gId('collection-leva-checkboxes'), sA=gId('select-all-levas'); c.innerHTML=''; if(levas.length===0){c.innerHTML='<p style="color:#888;font-style:italic;">Nenhuma leva.</p>';sA.disabled=true;sA.checked=false;return} sA.disabled=false; levas.forEach(lv=>{const d=cE('div');d.className='leva-checkbox-item';const cb=cE('input');cb.type='checkbox';cb.id=`cb-leva-${lv.id}`;cb.value=lv.id;cb.onchange=()=>{if(!cb.checked){sA.checked=false}else{const allCkd=Array.from(c.querySelectorAll('input')).every(i=>i.checked);sA.checked=allCkd}};const lb=cE('label');lb.htmlFor=cb.id;lb.textContent=lv.id;d.appendChild(cb);d.appendChild(lb);c.appendChild(d)}) }
        function toggleAllLevaCheckboxes(c) { qSA('#collection-leva-checkboxes input').forEach(cb=>cb.checked=c) }

        // --- FUNÇÕES DE IMPORTAÇÃO ---
        function handleFileSelect(event, processorFn) { /* ... (igual v7.8) ... */ const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { processorFn(e.target.result); } catch (error) { console.error(`Erro ${file.name}:`, error); alert(`Erro ao processar ${file.name}: ${error.message}`); } finally { event.target.value = null; } }; reader.onerror = () => { alert('Erro ao ler arquivo.'); event.target.value = null; }; reader.readAsText(file, 'UTF-8'); }
        function parseCSV(csvString) { /* ... (igual v7.8) ... */ console.log("[parseCSV v2] Iniciando parse..."); let content = csvString.trim(); if (content.charCodeAt(0) === 0xFEFF) { console.log("[parseCSV v2] BOM detectado e removido."); content = content.substring(1); } const lines = content.split(/\r?\n/); if (lines.length < 2) { throw new Error("CSV inválido ou vazio (cabeçalho + dados)."); } const headerLine = lines[0]; console.log("[parseCSV v2] Linha Cabeçalho:", JSON.stringify(headerLine)); const headers = headerLine.split(',').map(h => h.trim().toLowerCase()); console.log("[parseCSV v2] Cabeçalhos Processados:", headers); const data = []; const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/; for (let i = 1; i < lines.length; i++) { const line = lines[i].trim(); if (line === '') continue; const values = line.split(regex).map(val => { let cleanedVal = val.trim(); if (cleanedVal.startsWith('"') && cleanedVal.endsWith('"')) { cleanedVal = cleanedVal.substring(1, cleanedVal.length - 1).replace(/""/g, '"'); } return cleanedVal; }); if (values.length !== headers.length) { console.warn(`[parseCSV v2] Linha ${i+1} ignorada: colunas (${values.length}) != cabeçalho (${headers.length}). Linha: "${line}" \n Valores:`, values); continue; } const rowObject = {}; for (let j = 0; j < headers.length; j++) { rowObject[headers[j]] = values[j]; } data.push(rowObject); } console.log("[parseCSV v2] Parse concluído. Objetos:", data); return data; }
        function processLevaData(csvContent) { /* ... (igual v7.8) ... */ const pD=parseCSV(csvContent); if (!pD || pD.length === 0) throw new Error("CSV de Levas vazio ou inválido após parse."); const eH=["id_leva","data_inicio_agregacao","cor","linhas_celulares","nome_protocolo"]; const aH=Object.keys(pD[0]); console.log("[processLevaData] Cabeçalhos reais:", aH); console.log("[processLevaData] Cabeçalhos esperados:", eH); for (const e of eH) { if (!aH.includes(e)) { console.error(`[processLevaData] Falha ao encontrar: "${e}"`); throw new Error(`Cabeçalho esperado "${e}" não encontrado (Levas). Encontrados: [${aH.join(', ')}]`); } } const iL=[]; pD.forEach((r, idx)=>{ const id = r["id_leva"]?.trim(); const startDateStr = r["data_inicio_agregacao"]?.trim(); const color = r["cor"]?.trim() || '#cccccc'; const cellLines = r["linhas_celulares"]?.trim() || ''; const protocolName = r["nome_protocolo"]?.trim(); if (!id || !startDateStr || !protocolName) { console.warn(`Leva L${idx + 2} ignorada.`); return; } if (!/^\d{4}-\d{2}-\d{2}$/.test(startDateStr)) { console.warn(`Leva "${id}" L${idx + 2} ignorada: Data inválida.`); return; } iL.push({ id, startDate: startDateStr, color, protocolName, cellLines }); }); if (iL.length === 0) { alert("Nenhuma leva válida no CSV."); return; } if (confirm(`Importar ${iL.length} levas do CSV? (Substitui atuais)`)) { levas = iL; sortDataArrays(); saveData(); renderAllLists(); updateCollectionLevaCheckboxes(); alert("Levas importadas!") } }
        function processProtocolData(csvContent) { /* ... (igual v7) ... */ const pD=parseCSV(csvContent); const eH=["nome_protocolo","dia","tarefa_base","meio_especifico"]; const hM={}; const aH=Object.keys(pD[0]||{}); for(const e of eH){const f=aH.find(h=>h===e);if(!f)throw new Error(`Cabeçalho "${e}" não encontrado (Protocolo).`);hM[e]=f} const iP=[]; pD.forEach((r,idx)=>{const pN=r[hM["nome_protocolo"]]?.trim(),dS=r[hM["dia"]]?.trim(),bT=r[hM["tarefa_base"]]?.trim()||'-',sM=r[hM["meio_especifico"]]?.trim()||'-'; if(!pN||dS===undefined||dS===null||dS===''){console.warn(`Protocolo L${idx+2} ignorado.`);return} const d=parseInt(dS); if(isNaN(d)){console.warn(`Protocolo "${pN}" L${idx+2} ignorado: Dia inválido.`);return} iP.push({protocolName:pN,day:d,baseTask:bT,specificMedium:sM})}); if(iP.length===0){alert("Nenhum protocolo válido.");return} if(confirm(`Importar ${iP.length} passos CSV? (Substitui TODOS)`)){protocols=iP;sortDataArrays();saveData();renderProtocolList();alert("Protocolos importados!")} }
        function processCollectionData(csvContent) { /* ... (igual v7) ... */ const pD=parseCSV(csvContent); const eH=["levaids","dia","quantidade","experimento"]; const hM={}; const aH=Object.keys(pD[0]||{}); for(const e of eH){const f=aH.find(h=>h===e);if(!f)throw new Error(`Cabeçalho "${e}" não encontrado (Coletas).`);hM[e]=f} const iC=[]; pD.forEach((r,idx)=>{const lIdS=r[hM["levaids"]]?.trim(), dS=r[hM["dia"]]?.trim(), qty=r[hM["quantidade"]]?.trim()||'', exp=r[hM["experimento"]]?.trim()||''; if(!lIdS||dS===undefined||dS===null||dS===''){console.warn(`Coleta L${idx+2} ignorada.`);return} const d=parseInt(dS); if(isNaN(d)){console.warn(`Coleta L${idx+2} ignorada: Dia inválido.`);return} const lIds=lIdS.split(/[,;]/).map(id=>id.trim()).filter(id=>id!==''); if(lIds.length===0){console.warn(`Coleta L${idx+2} ignorada: Nenhum LevaId.`);return} iC.push({levaIds:lIds,day:d,qty:qty,exp:exp})}); if(iC.length===0){alert("Nenhuma coleta válida.");return} if(confirm(`Importar ${iC.length} coletas CSV? (Substitui atuais)`)){collections=iC;sortDataArrays();saveData();renderCollectionList();alert("Coletas importadas!")} }
        function handleJsonFileSelect(event) { /* ... (igual v7) ... */ const file = event.target.files[0]; if (!file) return; if (file.type !== 'application/json' && !file.name.toLowerCase().endsWith('.json')) { alert('Selecione .json'); event.target.value = null; return; } const reader = new FileReader(); reader.onload = (e) => { try { const iD = JSON.parse(e.target.result); if (!iD || typeof iD !== 'object' || !Array.isArray(iD.levas) || !Array.isArray(iD.protocols) || !Array.isArray(iD.collections)) { throw new Error("Estrutura JSON inválida."); } const nL = iD.levas.length; const nP = iD.protocols.length; const nC = iD.collections.length; if (confirm(`Importar JSON?\n\n- L:${nL} P:${nP} C:${nC}\n\n(Substitui TUDO)`)) { levas = iD.levas; protocols = iD.protocols; collections = iD.collections; sortDataArrays(); saveData(); renderAllLists(); updateCollectionLevaCheckboxes(); alert("Dados JSON importados!"); } } catch (error) { console.error("Erro JSON:", error); alert(`Erro JSON: ${error.message}`); } finally { event.target.value = null; } }; reader.onerror = () => { alert('Erro ao ler arquivo.'); event.target.value = null; }; reader.readAsText(file, 'UTF-8'); }

        // --- LÓGICA CENTRAL E FUNÇÕES AUXILIARES ---
        function daysBetween(d1, d2) { /* ... (igual v8.2) ... */ const msPerDay = 1000 * 60 * 60 * 24; const startOfDay1 = Date.UTC(d1.getUTCFullYear(), d1.getUTCMonth(), d1.getUTCDate()); const startOfDay2 = Date.UTC(d2.getUTCFullYear(), d2.getUTCMonth(), d2.getUTCDate()); const diffMs = startOfDay1 - startOfDay2; const diffDays = Math.floor(diffMs / msPerDay + 0.00001); return diffDays; }
        function gId(id){return document.getElementById(id)} function qSA(sel){return document.querySelectorAll(sel)} function cE(tag){return document.createElement(tag)}
        function initializeLastChangeDates() { /* ... (igual v8.2) ... */ lastMediaChangeDates = {}; levas.forEach(lv=>{const lS=new Date(lv.startDate+'T12:00:00Z');lastMediaChangeDates[lv.id]=new Date(lS.setUTCDate(lS.getUTCDate()+3))}); }

        // *** FUNÇÃO HELPER REUTILIZÁVEL (v8.3 - Lógica Troca Otimizada) ***
        function getDailyLevaInfo(currentDateUTC, leva, currentLastMediaChangeDates) {
            const levaStartDate = new Date(leva.startDate + 'T00:00:00Z');
            const currentDateStartOfDay = new Date(Date.UTC(currentDateUTC.getUTCFullYear(), currentDateUTC.getUTCMonth(), currentDateUTC.getUTCDate()));
            if (currentDateStartOfDay.getTime() < levaStartDate.getTime()) { return null; }

            const dayX = daysBetween(currentDateStartOfDay, levaStartDate);

            const step = protocols.find(p => p.protocolName === leva.protocolName && p.day === dayX);
            const baseTask = step ? step.baseTask : '-';
            const specificMedium = step ? step.specificMedium : '-';
            const currentDayOfWeek = currentDateUTC.getUTCDay(); // 0=Dom, 1=Seg...
            let finalTask = "-"; let finalMedium = "-"; let performMediaChange = false;
            const isCriticalTask = baseTask !== '-' && tarefasCriticasKeywords.some(keyword => baseTask.toLowerCase().includes(keyword.toLowerCase()));
            // Identifica tarefas críticas que *implicitamente* trocam o meio
            const criticalTaskImpliesMediaChange = isCriticalTask && (baseTask.toLowerCase().includes('transferir') || baseTask.toLowerCase().includes('plaquear') || specificMedium !== '-');

            // --- Lógica de Troca e Tarefa/Meio por Período ---
            if (dayX >= 0 && dayX <= 3) { // Dias 0 a 3: Lógica simples
                 finalMedium = specificMedium;
                 if (dayX === 0) { finalTask = baseTask; } // AGREGAR
                 else { finalTask = !isCriticalTask ? "Trocar Meio" : baseTask; } // Dias 1, 2, 3
                 // Registra CADA dia como 'última troca' neste período inicial
                 if(currentLastMediaChangeDates) currentLastMediaChangeDates[leva.id] = new Date(currentDateUTC);

            } else if (dayX >= 4 && dayX <= 31) { // Dias 4 a 31: Lógica Otimizada
                const lastChangeDate = currentLastMediaChangeDates ? (currentLastMediaChangeDates[leva.id] || new Date(levaStartDate.getTime() + 3 * 24*60*60*1000)) : new Date(levaStartDate.getTime() + 3 * 24*60*60*1000); // Dia 3 como ref
                const daysSince = daysBetween(currentDateStartOfDay, lastChangeDate);
                const isPreferredDay = preferredChangeDaysOfWeek.includes(currentDayOfWeek);
                const nextDay = new Date(currentDateUTC); nextDay.setUTCDate(currentDateUTC.getUTCDate() + 1);
                const mustChange = (daysSince >= 3) || (daysSince === 2 && nextDay.getUTCDay() === 0); // Safety net
                const isDayToSkip = [5, 12, 19, 26].includes(dayX); // Dias explícitos para pular

                let shouldChangeToday = false;

                if (isCriticalTask) {
                    // Tarefa Crítica: Usa tarefa/meio do protocolo.
                    finalTask = baseTask;
                    finalMedium = specificMedium;
                    // *** ATUALIZA lastChangeDate SE a tarefa crítica implica meio novo ***
                    if (criticalTaskImpliesMediaChange && currentLastMediaChangeDates) {
                        currentLastMediaChangeDates[leva.id] = new Date(currentDateUTC);
                        // console.log(`[v8.2] Leva ${leva.id} Dia ${dayX}: Critical Task (${finalTask}) updated lastChangeDate.`);
                    }
                } else { // Não é tarefa crítica
                    // *** REORDENADO: Verifica Skip PRIMEIRO (após crítico) ***
                    if (isDayToSkip && !mustChange) { // Pula apenas se não for forçado pelo safety net
                        shouldChangeToday = false;
                        // console.log(`[v8.2] Leva ${leva.id} Dia ${dayX}: Skipping change (day after switch).`);
                    } else if (mustChange) {
                        shouldChangeToday = true; // Safety net: troca obrigatória
                        // console.log(`[v8.2] Leva ${leva.id} Dia ${dayX}: Mandatory change (DaysSince=${daysSince}).`);
                    } else if (isPreferredDay) {
                        shouldChangeToday = true; // Dia preferencial (Seg/Qua/Sex)
                         // console.log(`[v8.2] Leva ${leva.id} Dia ${dayX}: Preferred change (Day ${currentDayOfWeek}).`);
                    } // Se não for nenhum, shouldChangeToday continua false

                    performMediaChange = shouldChangeToday;

                    if (performMediaChange) {
                        finalTask = "Trocar Meio";
                        if (dayX >= 25) finalMedium = "Meio 3";
                        else if (dayX >= 18) finalMedium = "Meio 2 + FGF2+EGF";
                        else if (dayX >= 11) finalMedium = "Meio 2 + FGF2";
                        else finalMedium = "Meio 1"; // Dias 4 a 10
                        if(currentLastMediaChangeDates) currentLastMediaChangeDates[leva.id] = new Date(currentDateUTC); // REGISTRA
                    } else {
                        // Sem troca agendada hoje, mostra apenas tarefa/meio base (se houver)
                        finalTask = baseTask;
                        finalMedium = specificMedium;
                         // Garante meio correto nos dias de switch sem troca agendada
                         if (dayX === 4 && finalMedium === '-') finalMedium = "Meio 1";
                         if (dayX === 11 && finalMedium === '-') finalMedium = "Meio 2 + FGF2";
                         if (dayX === 18 && finalMedium === '-') finalMedium = "Meio 2 + FGF2+EGF";
                         if (dayX === 25 && finalMedium === '-') finalMedium = "Meio 3";
                    }
                }

            } else if (dayX >= 32) { // Dias 32+: Manutenção Seg/Qua/Sex
                 const isMaintenanceChangeDay = preferredChangeDaysOfWeek.includes(currentDayOfWeek) && !isCriticalTask;
                 if (isMaintenanceChangeDay) { finalTask = "Trocar Meio (Manut.)"; finalMedium = meioManutencao; if(currentLastMediaChangeDates) currentLastMediaChangeDates[leva.id] = new Date(currentDateUTC); }
                 else { finalTask = baseTask; finalMedium = specificMedium; }
                 if (dayX === 32 && baseTask !== '-') finalTask = baseTask;
            }

            const dailyCollections = collections.filter(c => c.day === dayX && c.levaIds.includes(leva.id));

            // Retorna null apenas se TUDO estiver vazio/padrão
            if (finalTask === '-' && finalMedium === '-' && dailyCollections.length === 0) {
                 return null;
            }

            return { dayX, finalTask, finalMedium, dailyCollections };
         }


        // --- GERAÇÃO DO CALENDÁRIO VISUAL ---
        function generateCalendar() {
            // console.log("=========================================="); console.log("Gerar Cronograma Visual clicado!"); console.log("Protocolos carregados:", JSON.stringify(protocols, null, 2)); const defaultProtocolHasDay0 = protocols.some(p => p.protocolName === 'Trujillo_200' && p.day === 0); console.log("Protocolo 'Trujillo_200' possui Dia 0?", defaultProtocolHasDay0); console.log("=========================================="); // Logs de Debug

            const sDStr=gId('calendar-start-date').value, eDStr=gId('calendar-end-date').value, oD=gId('calendar-output');
            if(!sDStr||!eDStr){alert("Defina datas.");return} if(levas.length===0){alert("Nenhuma leva.");return} if(protocols.length===0){alert("Nenhum protocolo.");return}
            const sD=new Date(sDStr+'T12:00:00Z'), eD=new Date(eDStr+'T12:00:00Z'); if(eD<sD){alert("Data final antes da inicial.");return}
            const today=new Date(); today.setUTCHours(0,0,0,0); oD.innerHTML='Gerando...';
            initializeLastChangeDates(); // Reseta histórico antes de gerar
            let h=''; let cMd=new Date(Date.UTC(sD.getUTCFullYear(),sD.getUTCMonth(),1));

            while(cMd<=eD){ // Loop principal dos meses
                 const m=cMd.getUTCMonth(), y=cMd.getUTCFullYear();
                h+=`<div class="calendar-month"><h3>${cMd.toLocaleString('pt-BR',{month:'long',year:'numeric',timeZone:'UTC'})}</h3><table class="calendar-table"><thead><tr>${diasSemana.map(d=>`<th>${d}</th>`).join('')}</tr></thead><tbody>`;
                const fDoM=new Date(Date.UTC(y,m,1)); const sDay=fDoM.getUTCDay(); let cD=new Date(fDoM); cD.setUTCDate(cD.getUTCDate()-sDay);
                let done=false;
                while(!done){ // Loop das semanas
                    h+='<tr>';
                    for(let i=0;i<7;i++){ // Loop dos dias da semana
                        const dOM=cD.getUTCDate(), cMCk=cD.getUTCMonth(), cDoW=cD.getUTCDay();
                        const iCM=cMCk===m; const iWk=cDoW===0||cDoW===6; const cDUT0=new Date(cD);cDUT0.setUTCHours(0,0,0,0); const iTd=cDUT0.getTime()===today.getTime();
                        let cCls=[]; if(!iCM)cCls.push('other-month'); if(iWk&&iCM)cCls.push('weekend'); if(iTd)cCls.push('today');
                        h+=`<td class="${cCls.join(' ')}">`;
                        if(iCM){
                            h+=`<span class="day-number">${dOM}</span><div>`; // Container para entradas do dia
                            const cD4Diff=new Date(cD); // Data atual para cálculos
                            levas.forEach(lv=>{ // Loop para cada leva
                                // Passa a cópia do histórico atual para não interferir entre levas no mesmo dia
                                let tempLastChanges = { ...lastMediaChangeDates };
                                const dailyInfo = getDailyLevaInfo(cD4Diff, lv, tempLastChanges);
                                // Atualiza o histórico principal APENAS se houve mudança para esta leva
                                if (tempLastChanges[lv.id] !== lastMediaChangeDates[lv.id]) {
                                    lastMediaChangeDates[lv.id] = tempLastChanges[lv.id];
                                }

                                if (dailyInfo) { // Se houver algo para mostrar para esta leva neste dia
                                    const { dayX, finalTask, finalMedium, dailyCollections } = dailyInfo;
                                    // *** INÍCIO: Construção do HTML da Entrada da Leva ***
                                    let levaHTML = `<div class="leva-entry" style="border-left-color:${lv.color};" title="Linhas:${lv.cellLines||'N/A'}">`;
                                    levaHTML += `<div class="leva-info">${lv.id} DIA ${dayX}</div>`;
                                    if(finalTask!=='-') { levaHTML += `<div class="leva-task">${finalTask}</div>`; }
                                    if(finalMedium!=='-') { levaHTML += `<div class="leva-medium">${finalMedium}</div>`; }
                                    // *** Adiciona Coletas DENTRO do box da leva (FORMATO ATUALIZADO) ***
                                    dailyCollections.forEach(cl=>{
                                        levaHTML += `<div class="collection-info-inline" title="Coleta p/${cl.levaIds.join(',')}: ${cl.exp || 'N/A'} - ${cl.qty || 'N/A'}">`; // Tooltip Atualizado
                                        levaHTML += `<span class="collection-icon">C</span> ${cl.exp || 'Coleta'}: ${cl.qty || 'N/A'}</div>`; // Formato Exp: Qtd
                                    });
                                    levaHTML += `</div>`; // Fecha leva-entry
                                    // *** FIM: Construção do HTML ***
                                    h += levaHTML; // Adiciona o HTML construído ao dia
                                }
                             });
                            h+='</div>'; // Fecha container das entradas
                        }
                        h+='</td>';
                        cD.setUTCDate(cD.getUTCDate()+1);
                        if(cD.getUTCFullYear()>y||(cD.getUTCFullYear()===y&&cD.getUTCMonth()>m)){if(i<6){h+='<td class="other-month"></td>'.repeat(6-i)}done=true;break}
                    }
                    h+='</tr>';
                }
                h+='</tbody></table></div>';
                cMd.setUTCMonth(cMd.getUTCMonth()+1);
            }
            oD.innerHTML=h;
         }


        // --- FUNÇÕES DE EXPORTAÇÃO ---
        // (Sem mudanças)
        function downloadFile(f,c,m){const b=new Blob([c],{type:m});const u=URL.createObjectURL(b);const a=cE('a');a.href=u;a.download=f;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);}
        function escapeCsvField(f) { if(f===null||f===undefined)return'""'; const s=String(f); if(s.includes(',')||s.includes('"')||s.includes('\n'))return`"${s.replace(/"/g,'""')}"`; return s; }
        function exportTasksToday() { /* ... */ const t=new Date(); const tU=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),12,0,0)); const tS=t.toLocaleDateString('pt-BR'); let o=`Tarefas para ${tS}:\n\n`; let f=false; initializeLastChangeDates(); levas.forEach(lv=>{ const dI=getDailyLevaInfo(tU,lv,lastMediaChangeDates); if(dI){const{dayX,finalTask,finalMedium,dailyCollections}=dI;if(finalTask!=='-'||finalMedium!=='-'||dailyCollections.length>0){f=true;o+=`--- Leva ${lv.id} (Dia ${dayX}) ---\n`;if(finalTask!=='-')o+=`Tarefa: ${finalTask}\n`;if(finalMedium!=='-')o+=`Meio: ${finalMedium}\n`;dailyCollections.forEach(cl=>{o+=`Coleta: ${cl.exp || 'Coleta'}: ${cl.qty || 'N/A'}\n`});o+='\n'}} }); if(!f)o+="Nenhuma tarefa ou coleta."; downloadFile(`tarefas_hoje_${t.toISOString().split('T')[0]}.txt`,o,'text/plain;charset=utf-8;'); } // Formato coleta TXT atualizado
        function exportDataJson() { /* ... */ const dE={levas,protocols,collections}; const jS=JSON.stringify(dE,null,2); downloadFile('cronograma_organoides_dados.json',jS,'application/json;charset=utf-8;'); }
        function exportScheduleCsv() { /* ... */ const sDS=gId('calendar-start-date').value, eDS=gId('calendar-end-date').value; if(!sDS||!eDS){alert("Defina datas p/ CSV.");return} const sD=new Date(sDS+'T12:00:00Z'), eD=new Date(eDS+'T12:00:00Z'); if(eD<sD){alert("Data final antes da inicial.");return} gId('csv-processing').style.display='inline'; setTimeout(()=>{const h=['Data','Dia_Semana','ID_Leva','Dia_X','Tipo','Descricao','Detalhes'];let cC='\uFEFF';cC+=h.map(escapeCsvField).join(',')+'\n'; initializeLastChangeDates(); let eLC={...lastMediaChangeDates}; let cD=new Date(sD); while(cD<=eD){const dS=cD.toLocaleDateString('pt-BR',{timeZone:'UTC'});const dOWS=diasSemana[cD.getUTCDay()]; levas.forEach(lv=>{const dI=getDailyLevaInfo(cD,lv,eLC);if(dI){const{dayX,finalTask,finalMedium,dailyCollections}=dI; if(finalTask!=='-'||finalMedium!=='-'){cC+=[dS,dOWS,lv.id,dayX,'Atividade',finalTask,finalMedium].map(escapeCsvField).join(',')+'\n'} dailyCollections.forEach(cl=>{cC+=[dS,dOWS,lv.id,dayX,'Coleta',cl.exp,cl.qty].map(escapeCsvField).join(',')+'\n'}) }}); cD.setUTCDate(cD.getUTCDate()+1);} downloadFile(`cronograma_organoides_${sDS}_a_${eDS}.csv`,cC,'text/csv;charset=utf-8;'); gId('csv-processing').style.display='none'; },50); } // Colunas CSV coleta atualizadas

        // --- INICIALIZAÇÃO ---
        // *** getDefaultProtocols ATUALIZADO para Dia 0 ***
        function getDefaultProtocols() { /* ... (igual v8.1) ... */ const dPN="Trujillo_200"; const pS=[ {protocolName:dPN,day:0,baseTask:'AGREGAR',specificMedium:'E8 + 20uM Rocki'}, {protocolName:dPN,day:1,baseTask:'Indução Neural D1 (+100uL)',specificMedium:'E8 + 2uM Dorso + 20uM SB'}, {protocolName:dPN,day:2,baseTask:'Indução Neural D2 (- + 150uL)',specificMedium:'E8 + 1uM Dorso + 10uM SB'}, {protocolName:dPN,day:3,baseTask:'Indução Neural D3 (- + 150uL)',specificMedium:'E8 + 1uM Dorso + 10uM SB'}, {protocolName:dPN,day:4,baseTask:'Transferir ~10 CtO/well // Início Meio 1',specificMedium:'Meio 1'}, {protocolName:dPN,day:5,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:6,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:7,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:8,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:9,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:10,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:11,baseTask:'Plaquear 5 CtO/Well / Início Meio 2+FGF2',specificMedium:'Meio 2 + FGF2'}, {protocolName:dPN,day:12,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:13,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:14,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:15,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:16,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:17,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:18,baseTask:'Adicionar EGF / Início Meio 2+FGF2+EGF',specificMedium:'Meio 2 + FGF2+EGF'}, {protocolName:dPN,day:19,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:20,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:21,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:22,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:23,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:24,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:25,baseTask:'Início Meio 3',specificMedium:'Meio 3'}, {protocolName:dPN,day:26,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:27,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:28,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:29,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:30,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:31,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:32,baseTask:'Organoides Formados! / Manutenção',specificMedium:meioManutencao}, ...Array.from({length:61},(_,i)=>({protocolName:dPN,day:33+i,baseTask:'-',specificMedium:'-'})) ]; return pS; }
        window.onload = () => {
             loadData(); const tFC = new Date(); const fD = new Date(tFC.getFullYear(), tFC.getMonth(), 1); const lD = new Date(tFC.getFullYear(), tFC.getMonth() + 2, 0);
             const fDt = (d) => d.toISOString().split('T')[0]; gId('calendar-start-date').value = fDt(fD); gId('calendar-end-date').value = fDt(lD);
             // Mantém exemplo v7 (Trujillo_200)
             if (levas.length === 0 && localStorage.getItem(LEVAS_KEY) === null) { levas = [ { id: 'L2', startDate: '2025-03-20', color: 'pink', protocolName: 'Trujillo_200', cellLines: '14vz, 14T' }, { id: 'L3', startDate: '2025-03-27', color: 'lightgreen', protocolName: 'Trujillo_200', cellLines: '7vz, 7T, 8vz, 8T' }, { id: 'L4', startDate: '2025-04-03', color: 'lightblue', protocolName: 'Trujillo_200', cellLines: '7vz, 7T, 8vz, 8T' }, { id: 'L5', startDate: '2025-04-22', color: 'orange', protocolName: 'Trujillo_200', cellLines: '7vz, 7T, 8vz, 8T, 14vz, 14T' } ]; sortDataArrays(); saveData(); renderAllLists(); updateCollectionLevaCheckboxes(); }
         };
    </script>

</body>
</html>