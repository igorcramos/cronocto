<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Cronograma v9.6.1 (Fix Importação CSV)</title>
    <style>
        :root { --primary-color: #007bff; --secondary-color: #6c757d; --success-color: #28a745; --warning-color: #ffc107; --danger-color: #dc3545; --light-gray: #f8f9fa; --medium-gray: #e9ecef; --dark-gray: #6c757d; --text-color: #333; --border-color: #dee2e6; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; margin: 0; padding: 15px; background-color: #f4f7f6; color: var(--text-color); }
        .container { display: grid; grid-template-columns: minmax(350px, 1.5fr) 3fr; gap: 25px; max-width: 1700px; margin: auto; }
        .input-section, .output-section { background-color: #fff; border: 1px solid var(--border-color); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .input-section h2, .output-section h2 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; color: var(--text-color); font-size: 1.4em; }
        .input-section h3 { margin-top: 25px; margin-bottom: 10px; color: #555; border-bottom: 1px dashed #eee; padding-bottom: 5px; font-size: 1.15em; }
        .input-section h4 { margin-top: 15px; margin-bottom: 5px; color: #666; font-size: 1em; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; color: #444; }
        input[type="text"], input[type="date"], input[type="number"], input[type="color"], select, textarea, input[type="file"] { width: calc(100% - 18px); padding: 9px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.95em; background-color: #fff; }
        input:focus, textarea:focus, select:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2); }
        textarea { height: 60px; resize: vertical; }
        input[type="file"] { padding: 5px; }
        button { padding: 10px 15px; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px; margin-right: 5px; font-size: 0.95em; transition: background-color 0.2s ease, transform 0.1s ease; }
        button:hover { filter: brightness(110%); }
        button:active { transform: translateY(1px); }
        button.primary-btn { background-color: var(--primary-color); }
        button.edit-btn { background-color: var(--warning-color); color: #333; }
        button.remove-btn { background-color: var(--danger-color); padding: 3px 8px; font-size: 0.8em; margin: 0 0 0 5px; }
        button.save-edit-btn { background-color: var(--success-color); }
        button.clear-btn { background-color: var(--secondary-color); }
        button.export-btn { background-color: #17a2b8; }
        button.import-btn { background-color: #fd7e14; }
        button.view-btn { background-color: #6f42c1; }
        .data-list { list-style: none; padding: 0; max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; margin-top: 10px; padding: 10px; background-color: #fdfdfd; }
        .data-list li { font-size: 0.9em; margin-bottom: 8px; padding: 8px; background-color: var(--light-gray); border: 1px solid #eee; border-radius: 3px; display: flex; justify-content: space-between; align-items: center; }
        .data-list li .item-content { flex-grow: 1; margin-right: 10px; line-height: 1.4; }
        .data-list li .item-actions button { margin-left: 5px; }
        .color-swatch { display: inline-block; width: 15px; height: 15px; border: 1px solid #ccc; margin-right: 8px; vertical-align: middle; border-radius: 3px; }
        .leva-checkbox-container { max-height: 120px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; border-radius: 4px; background-color: var(--light-gray); }
        .leva-checkbox-item { display: block; margin-bottom: 5px; }
        .leva-checkbox-item input[type="checkbox"] { width: auto; margin-right: 8px; vertical-align: middle; }
        .leva-checkbox-item label { display: inline; font-weight: normal; font-size: 0.95em; }
        #select-all-levas-label { display: block; margin-bottom: 8px; font-weight: bold; padding-bottom: 5px; border-bottom: 1px dashed #ccc; }
        #select-all-levas-label input { width: auto; margin-right: 5px; vertical-align: middle; }
        .calendar-output { margin-top: 20px; }
        #save-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--success-color); color: white; padding: 10px 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; opacity: 0; transition: opacity 0.5s ease-in-out; }
        #save-notification.show { opacity: 1; }
        .processing-feedback { display: inline-block; margin-left: 10px; color: var(--secondary-color); font-style: italic; }
        #import-section p, #export-section p {font-size: 0.85em; color: var(--dark-gray); margin-top: 0;}
        #export-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }

        .desktop-calendar .calendar-month { margin-bottom: 15px; }
        .desktop-calendar .calendar-month h3 { background-color: var(--medium-gray); padding: 8px; text-align: center; border-radius: 4px 4px 0 0; color: #495057; font-size: 1.1em; font-weight: 600; }
        .desktop-calendar .calendar-table { width: 100%; border-collapse: collapse; table-layout: fixed; background-color: #fff; }
        .desktop-calendar .calendar-table th, .desktop-calendar .calendar-table td { border: 1px solid var(--border-color); padding: 6px; text-align: left; vertical-align: top; height: 160px; font-size: 0.8em; word-wrap: break-word; position: relative; }
        .desktop-calendar .calendar-table th { background-color: var(--light-gray); text-align: center; height: auto; font-weight: bold; }
        .desktop-calendar .day-number { position: absolute; top: 3px; right: 5px; font-weight: bold; color: var(--dark-gray); font-size: 1.1em; }
        .desktop-calendar .calendar-table td > div { margin-top: 20px; max-height: 130px; overflow-y: auto; padding-right: 3px; }
        .desktop-calendar .leva-entry { margin-bottom: 4px; padding: 4px 6px; border-radius: 3px; border-left: 4px solid; background-color: #fff; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }
        .desktop-calendar .leva-info { font-weight: bold; font-size: 0.95em; margin-bottom: 2px;}
        .desktop-calendar .leva-task { font-style: italic; margin-bottom: 2px;}
        .desktop-calendar .leva-medium { font-size: 0.9em; color: #555; }
        .desktop-calendar .collection-info-inline { margin-top: 3px; padding: 2px 4px; border: 1px dashed var(--success-color); border-radius: 2px; background-color: #f0fff4; font-size: 0.95em; display: block; }
        .desktop-calendar .collection-icon { display: inline-block; color: var(--success-color); font-weight: bold; margin-right: 3px; }
        .desktop-calendar .weekend { background-color: var(--light-gray); }
        .desktop-calendar .other-month { background-color: #f8f9fa; }
        .desktop-calendar .other-month .day-number { display: none; }
        .desktop-calendar .today { border: 3px solid var(--primary-color) !important; }

        .mobile-calendar .calendar-month { margin-bottom: 10px; }
        .mobile-calendar .calendar-month h3 { background-color: var(--medium-gray); padding: 8px; text-align: center; border-radius: 4px; color: #495057; font-size: 1.2em; font-weight: 600; margin-bottom: 15px; }
        .mobile-calendar .mobile-day-row { background-color: #fff; border: 1px solid var(--border-color); margin-bottom: 12px; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.08); }
        .mobile-calendar .mobile-day-header { background-color: var(--light-gray); padding: 8px 12px; font-weight: bold; border-bottom: 1px solid var(--border-color); border-radius: 6px 6px 0 0; font-size: 1.05em; color: #495057; }
        .mobile-calendar .mobile-day-header.weekend { background-color: #f1f3f5; }
        .mobile-calendar .mobile-day-header.today { border-left: 4px solid var(--primary-color); padding-left: 8px; }
        .mobile-calendar .mobile-levas-container { padding: 10px 12px; display: flex; flex-wrap: wrap; gap: 8px; }
        .mobile-calendar .mobile-leva-entry { border: 1px solid var(--border-color); padding: 8px; border-radius: 4px; background-color: #fff; border-left: 5px solid; flex: 1 1 150px; min-width: 140px; font-size: 0.9em; }
        .mobile-calendar .mobile-leva-entry .leva-info { font-size: 1em; font-weight: bold; margin-bottom: 3px; }
        .mobile-calendar .mobile-leva-entry .leva-task { font-style: italic; margin-bottom: 3px; }
        .mobile-calendar .mobile-leva-entry .leva-medium { font-size: 0.95em; color: #555; margin-bottom: 3px; }
        .mobile-calendar .mobile-leva-entry .collection-info-inline { margin-top: 5px; font-size: 0.95em; }
        .mobile-calendar .mobile-leva-entry .collection-icon { font-size: 1em; }

        .mobile-calendar { display: none; }
        .desktop-calendar { display: block; }
        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } .desktop-calendar { display: none; } .mobile-calendar { display: block; } }
        @media (max-width: 480px) { button.primary-btn, button.export-btn, button.import-btn, button.danger-btn, button.view-btn { width: 100%; margin-bottom: 8px; margin-right: 0; } .data-list li { flex-direction: column; align-items: flex-start; } .data-list li .item-actions { margin-top: 8px; width: 100%; display: flex; justify-content: flex-end; } .mobile-calendar .mobile-leva-entry { flex-basis: calc(100% - 16px); } }
    </style>
</head>
<body>
    <div id="save-notification">Dados salvos localmente!</div>
    <h1>Gerador de Cronograma v9.6.1 (Fix Importação CSV)</h1>

    <div class="container">
        <div class="input-section">
            <h2>1. Dados de Entrada</h2>
             <p style="font-size: 0.85em; color: var(--dark-gray);">As informações são salvas automaticamente no seu navegador.</p>
            <div id="import-section">
                 <h3>Importar Dados</h3>
                <p>Importe de arquivos CSV (UTF-8, vírgula) ou JSON. Substitui dados atuais.</p>
                <div> <label for="leva-csv-input">Importar Levas (.csv):</label> <input type="file" id="leva-csv-input" accept=".csv" onchange="handleFileSelect(event, processLevaData)"> </div>
                <div> <label for="protocol-csv-input">Importar Protocolo(s) (.csv):</label> <input type="file" id="protocol-csv-input" accept=".csv" onchange="handleFileSelect(event, processProtocolData)"> </div>
                <div> <label for="collection-csv-input">Importar Coletas (.csv):</label> <input type="file" id="collection-csv-input" accept=".csv" onchange="handleFileSelect(event, processCollectionData)"> </div>
                <div> <label for="json-import-input">Importar Backup Completo (.json):</label> <input type="file" id="json-import-input" accept=".json,application/json" onchange="handleJsonFileSelect(event)"> </div>
            </div>
            <hr style="margin: 30px 0;">
            <form id="leva-form"> <input type="hidden" id="leva-edit-index"> <h3>Gerenciar Leva (Manual)</h3> <label for="leva-id">ID Leva:</label><input type="text" id="leva-id" required>
                <label for="leva-start-date">Data Início Agregação (Dia 0):</label> <input type="date" id="leva-start-date" required>
                <label for="leva-color">Cor:</label><input type="color" id="leva-color" value="#add8e6"><input type="text" id="leva-color-text" placeholder="Ou digite nome/hex"> <label for="leva-protocol">Nome do Protocolo:</label><input type="text" id="leva-protocol" value="Trujillo_200" required> <label for="leva-cell-lines">Linhas Celulares:</label><input type="text" id="leva-cell-lines" placeholder="Ex: 7007-1, 8799-1"> <button type="button" id="add-edit-leva-btn" class="primary-btn" onclick="addOrUpdateLeva()">Adicionar Leva</button> <button type="button" onclick="clearLevaForm()" class="clear-btn">Cancelar Edição</button> </form>
            <h4>Levas Atuais:</h4> <ul id="levas-list" class="data-list"></ul>
            <hr style="margin: 30px 0;">
            <form id="protocol-form"> <h3>Gerenciar Protocolo (Manual)</h3> <label for="protocol-name">Nome do Protocolo:</label><input type="text" id="protocol-name" value="Trujillo_200" required> <label for="protocol-day">Dia (relativo, 0=Agregação):</label><input type="number" id="protocol-day" required> <label for="protocol-task">Tarefa Base:</label><input type="text" id="protocol-task" placeholder="Ex: AGREGAR, -"> <label for="protocol-medium">Meio Específico (ou '-'):</label><input type="text" id="protocol-medium" placeholder="Ex: Pré-indução, -"> <button type="button" class="primary-btn" onclick="addProtocolStep()">Adicionar/Atualizar Passo</button> <p style="font-size: 0.8em; color: var(--dark-gray);">Adicionar passo p/ dia existente atualiza.</p> </form>
            <h4>Protocolos Definidos:</h4> <ul id="protocols-list" class="data-list"></ul>
             <hr style="margin: 30px 0;">
             <form id="collection-form"> <h3>Adicionar Coleta (Manual)</h3> <label>Para Leva(s):</label> <div class="leva-checkbox-container"> <label id="select-all-levas-label"><input type="checkbox" id="select-all-levas" onchange="toggleAllLevaCheckboxes(this.checked)"> Selecionar Todas / Nenhuma</label> <div id="collection-leva-checkboxes"><p style="color: #888; font-style: italic;">Nenhuma leva.</p></div> </div> <label for="collection-day">No Dia do Protocolo (0=Agregação):</label><input type="number" id="collection-day" required placeholder="Ex: 32, 61"> <label for="collection-qty">Quantidade/Detalhes:</label><input type="text" id="collection-qty" placeholder="Ex: 5 organoides"> <label for="collection-exp">Experimento(s):</label><textarea id="collection-exp" placeholder="Ex: RNA-seq, IF"></textarea> <button type="button" class="primary-btn" onclick="addCollection()">Adicionar Coleta</button> </form>
             <h4>Coletas Planejadas:</h4> <ul id="collections-list" class="data-list"></ul>
             <hr style="margin: 30px 0;">
            <h3>Gerar Calendário & Exportar</h3>
             <label for="calendar-start-date">Data Início Calendário:</label><input type="date" id="calendar-start-date" required>
             <label for="calendar-end-date">Data Fim Calendário:</label><input type="date" id="calendar-end-date" required>
             <button type="button" class="primary-btn" onclick="generateCalendar()">Gerar Cronograma Visual</button>
             <div id="export-section">
                 <p>Exporte tarefas do dia, um backup JSON ou o cronograma completo em CSV.</p>
                 <button type="button" class="view-btn" onclick="showTasksTodayInNewTab()">Ver Tarefas de Hoje (Nova Aba)</button>
                 <button type="button" class="export-btn" onclick="exportDataJson()">Dados (JSON)</button>
                 <button type="button" class="export-btn" onclick="exportScheduleCsv()">Cronograma (CSV)</button>
                 <span id="csv-processing" class="processing-feedback" style="display: none;">Processando CSV...</span>
             </div>
             <hr style="margin: 30px 0;">
             <button type="button" onclick="clearAllDataStored()" class="danger-btn" style="background-color: var(--danger-color);">Limpar TODOS os Dados Salvos</button>
        </div>
        <div class="output-section">
            <h2>2. Cronograma Visual</h2>
            <div id="calendar-output">
                <div class="desktop-calendar" style="display: none;"></div>
                <div class="mobile-calendar" style="display: none;"></div>
                <p id="calendar-placeholder">Use a entrada manual ou importe arquivos. Clique em "Gerar Cronograma".</p>
            </div>
        </div>
    </div>

    <script>
        let levas = []; let protocols = []; let collections = []; let editingLevaIndex = null;
        let lastMediaChangeDates = {};
        const diasSemana = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sab"];
        const tarefasCriticasKeywords = ["AGREGAR", "Transferir", "Plaquear", "Organoides formados", "Indução"];
        const meioManutencao = "Meio 2 (Manutenção)";
        const preferredChangeDaysOfWeek = [1, 5];
        const LEVAS_KEY = 'cronogramaLevas_v8'; const PROTOCOLS_KEY = 'cronogramaProtocols_v8'; const COLLECTIONS_KEY = 'cronogramaCollections_v8';
        const MOBILE_BREAKPOINT = 768;

        function showSaveNotification() { const n=gId('save-notification');if(!n)return; n.classList.add('show'); setTimeout(()=>{n.classList.remove('show')},1500); }
        function saveData() { try { localStorage.setItem(LEVAS_KEY, JSON.stringify(levas)); localStorage.setItem(PROTOCOLS_KEY, JSON.stringify(protocols)); localStorage.setItem(COLLECTIONS_KEY, JSON.stringify(collections)); showSaveNotification(); console.log("Data saved (v9.6.1)."); } catch (e) { console.error("Error saving data:", e); alert(`Erro: ${e.message}.`); }}
        function loadData() { try { const sL=localStorage.getItem(LEVAS_KEY),sP=localStorage.getItem(PROTOCOLS_KEY),sC=localStorage.getItem(COLLECTIONS_KEY); levas=sL?JSON.parse(sL):[]; protocols=sP?JSON.parse(sP):getDefaultProtocols(); collections=sC?JSON.parse(sC):[]; sortDataArrays(); console.log("Data loaded (v9.6.1)."); } catch (e) { console.error("Error loading data:",e);alert("Erro ao carregar.");levas=[];protocols=getDefaultProtocols();collections=[] } renderAllLists();updateCollectionLevaCheckboxes(); }
        function clearAllDataStored() { if(confirm("ATENÇÃO! Remover PERMANENTEMENTE todos os dados salvos?")){localStorage.removeItem(LEVAS_KEY);localStorage.removeItem(PROTOCOLS_KEY);localStorage.removeItem(COLLECTIONS_KEY);levas=[];protocols=getDefaultProtocols();collections=[];renderAllLists();updateCollectionLevaCheckboxes();gId('calendar-output').innerHTML = '<div class="desktop-calendar" style="display:none;"></div><div class="mobile-calendar" style="display:none;"></div><p id="calendar-placeholder">Dados limpos.</p>';alert("Dados removidos.")} }
        function sortDataArrays() { levas.sort((a,b)=>a.id.localeCompare(b.id)); protocols.sort((a,b)=>{if(a.protocolName!==b.protocolName)return a.protocolName.localeCompare(b.protocolName);return a.day-b.day}); collections.sort((a,b)=>{const lA=(a.levaIds&&a.levaIds.length>0?a.levaIds[0]:'');const lB=(b.levaIds&&b.levaIds.length>0?b.levaIds[0]:'');const lC=lA.localeCompare(lB);return lC!==0?lC:a.day-b.day}); }
        function renderAllLists() { renderLevaList(); renderProtocolList(); renderCollectionList(); }

        function addOrUpdateLeva() { const id=gId('leva-id').value.trim(),sD=gId('leva-start-date').value,cP=gId('leva-color').value,cT=gId('leva-color-text').value.trim(),pN=gId('leva-protocol').value.trim(),cL=gId('leva-cell-lines').value.trim(); if(!id||!sD||!pN){alert("ID, Data Início, Prot. obrigatórios.");return} const color=cT||cP; const nLd={id,startDate:sD,color,protocolName:pN,cellLines:cL}; if(editingLevaIndex!==null){levas[editingLevaIndex]=nLd}else{if(levas.some(l=>l.id===id)){alert(`ID "${id}" já existe.`);return}levas.push(nLd)} sortDataArrays();saveData();renderLevaList();updateCollectionLevaCheckboxes();initializeLastChangeDates();clearLevaForm(); }
        function editLeva(i) { const l=levas[i];gId('leva-edit-index').value=i;gId('leva-id').value=l.id;gId('leva-start-date').value=l.startDate;gId('leva-color').value=l.color.startsWith('#')?l.color:'#cccccc';gId('leva-color-text').value=l.color;gId('leva-protocol').value=l.protocolName;gId('leva-cell-lines').value=l.cellLines;gId('add-edit-leva-btn').textContent='Salvar Edição';gId('add-edit-leva-btn').classList.add('save-edit-btn');editingLevaIndex=i;gId('leva-id').focus(); }
        function removeLeva(i) { if(confirm(`Remover leva "${levas[i].id}"?`)){levas.splice(i,1);saveData();renderLevaList();updateCollectionLevaCheckboxes();initializeLastChangeDates();if(editingLevaIndex===i)clearLevaForm()} }
        function clearLevaForm() { gId('leva-form').reset();gId('leva-edit-index').value='';gId('add-edit-leva-btn').textContent='Adicionar Leva';gId('add-edit-leva-btn').classList.remove('save-edit-btn');editingLevaIndex=null;gId('leva-protocol').value='Trujillo_200'; }
        function renderLevaList() { const l=gId('levas-list');l.innerHTML='';levas.forEach((lv,i)=>{const li=cE('li'),c=cE('div');c.className='item-content';c.innerHTML=`<span class="color-swatch" style="background-color:${lv.color};"></span><strong>${lv.id}</strong> (${lv.startDate}) - Prot:${lv.protocolName}<br><small><i>Linhas:${lv.cellLines||'N/A'}</i></small>`;const a=cE('div');a.className='item-actions';const eB=cE('button');eB.textContent='Editar';eB.className='edit-btn';eB.onclick=()=>editLeva(i);const rB=cE('button');rB.textContent='Remover';rB.className='remove-btn';rB.onclick=()=>removeLeva(i);a.appendChild(eB);a.appendChild(rB);li.appendChild(c);li.appendChild(a);l.appendChild(li)}) }
        function addProtocolStep() { const pN=gId('protocol-name').value.trim(),d=parseInt(gId('protocol-day').value),bT=gId('protocol-task').value.trim()||'-',sM=gId('protocol-medium').value.trim()||'-'; if(!pN||isNaN(d)){alert("Nome Prot. e Dia obrigatórios.");return} protocols=protocols.filter(p=>!(p.protocolName===pN&&p.day===d));protocols.push({protocolName:pN,day:d,baseTask:bT,specificMedium:sM});sortDataArrays();saveData();renderProtocolList();gId('protocol-day').value='';gId('protocol-task').value='';gId('protocol-medium').value=''; }
        function removeProtocolStep(i) { if(confirm(`Remover passo Dia ${protocols[i].day} do prot. "${protocols[i].protocolName}"?`)){protocols.splice(i,1);saveData();renderProtocolList()}}
        function renderProtocolList() { const l=gId('protocols-list');l.innerHTML='';protocols.forEach((s,i)=>{const li=cE('li'),c=cE('div');c.className='item-content';c.innerHTML=`<strong>${s.protocolName} - Dia ${s.day}</strong><br>T:${s.baseTask} <br>M:${s.specificMedium}`;const a=cE('div');a.className='item-actions';const rB=cE('button');rB.textContent='Remover';rB.className='remove-btn';rB.onclick=()=>removeProtocolStep(i);a.appendChild(rB);li.appendChild(c);li.appendChild(a);l.appendChild(li)}) }
        function addCollection() { const cbs=qSA('#collection-leva-checkboxes input:checked'),sIds=Array.from(cbs).map(cb=>cb.value);const d=parseInt(gId('collection-day').value),q=gId('collection-qty').value.trim(),e=gId('collection-exp').value.trim(); if(sIds.length===0||isNaN(d)){alert("Selecione Leva(s) e Dia.");return} collections.push({levaIds:sIds,day:d,qty:q,exp:e});sortDataArrays();saveData();renderCollectionList();gId('collection-form').reset();qSA('#collection-leva-checkboxes input').forEach(cb=>cb.checked=false);gId('select-all-levas').checked=false; }
        function removeCollection(i) { if(confirm(`Remover coleta p/ Leva(s) ${collections[i].levaIds.join(',')} Dia ${collections[i].day}?`)){collections.splice(i,1);saveData();renderCollectionList()}}
        function renderCollectionList() { const l=gId('collections-list');l.innerHTML='';collections.forEach((c,i)=>{const li=cE('li'),ct=cE('div');ct.className='item-content';ct.innerHTML=`<strong>Leva(s):${c.levaIds.join(', ')} - Dia ${c.day}</strong><br>Qtd:${c.qty||'N/A'}<br>Exp:${c.exp||'N/A'}`;const a=cE('div');a.className='item-actions';const rB=cE('button');rB.textContent='Remover';rB.className='remove-btn';rB.onclick=()=>removeCollection(i);a.appendChild(rB);li.appendChild(ct);li.appendChild(a);l.appendChild(li)}) }
        function updateCollectionLevaCheckboxes() { const c=gId('collection-leva-checkboxes'),sA=gId('select-all-levas');c.innerHTML='';if(levas.length===0){c.innerHTML='<p style="color:#888;font-style:italic;">Nenhuma leva.</p>';sA.disabled=true;sA.checked=false;return}sA.disabled=false;levas.forEach(lv=>{const d=cE('div');d.className='leva-checkbox-item';const cb=cE('input');cb.type='checkbox';cb.id=`cb-leva-${lv.id}`;cb.value=lv.id;cb.onchange=()=>{if(!cb.checked)sA.checked=false;else{const allCkd=Array.from(c.querySelectorAll('input')).every(i=>i.checked);sA.checked=allCkd}};const lb=cE('label');lb.htmlFor=cb.id;lb.textContent=lv.id;d.appendChild(cb);d.appendChild(lb);c.appendChild(d)}) }
        function toggleAllLevaCheckboxes(c) { qSA('#collection-leva-checkboxes input').forEach(cb=>cb.checked=c) }

        // *** FUNÇÃO RESTAURADA ***
        function handleFileSelect(event, processorFn) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    processorFn(e.target.result);
                } catch (error) {
                    console.error(`Erro ao processar ${file.name}:`, error);
                    alert(`Erro ao processar ${file.name}: ${error.message}`);
                } finally {
                    event.target.value = null;
                }
            };
            reader.onerror = () => {
                alert('Erro ao ler arquivo.');
                event.target.value = null;
            };
            reader.readAsText(file, 'UTF-8');
        }

        function parseCSV(csvS){let c=csvS.trim();if(c.charCodeAt(0)===0xFEFF)c=c.substring(1);const ls=c.split(/\r?\n/);if(ls.length<2)throw Error("CSV inválido.");const hs=ls[0].split(',').map(h=>h.trim().toLowerCase());const d=[];const rgx=/, (?=(?:(?:[^"]*"){2})*[^"]*$)/;for(let i=1;i<ls.length;i++){const l=ls[i].trim();if(l==='')continue;const vs=l.split(rgx).map(v=>{let clV=v.trim();if(clV.startsWith('"')&&clV.endsWith('"'))clV=clV.substring(1,clV.length-1).replace(/""/g,'"');return clV});if(vs.length!==hs.length)continue;const rO={};for(let j=0;j<hs.length;j++)rO[hs[j]]=vs[j];d.push(rO)}return d}
        function processLevaData(csvContent) {
            try {
                const pD=parseCSV(csvContent); if (!pD || pD.length === 0) throw new Error("CSV Levas vazio.");
                const eH=["id_leva","data_inicio_agregacao","cor","linhas_celulares","nome_protocolo"]; const aH=Object.keys(pD[0]);
                for (const e of eH) { if (!aH.includes(e)) throw Error(`Cabeçalho "${e}" não achado.`); }
                const iL=[]; pD.forEach(r=>{const id=r.id_leva?.trim(),sS=r.data_inicio_agregacao?.trim(),col=r.cor?.trim()||'#ccc',cl=r.linhas_celulares?.trim()||'',pN=r.nome_protocolo?.trim();if(!id||!sS||!pN)return;if(!/^\d{4}-\d{2}-\d{2}$/.test(sS))return;iL.push({id,startDate:sS,color:col,protocolName:pN,cellLines:cl})});
                if(iL.length===0){alert("Nenhuma leva válida.");return}
                if(confirm(`Importar ${iL.length} levas? (Substitui)`)){levas=iL;sortDataArrays();saveData();renderAllLists();updateCollectionLevaCheckboxes();initializeLastChangeDates();alert("Levas importadas!")}
            } catch (error) {
                console.error("Erro em processLevaData:", error);
                alert("Erro ao processar CSV de Levas: " + error.message);
            }
        }
        function processProtocolData(csvContent){
            try {
                const pD=parseCSV(csvContent);const eH=["nome_protocolo","dia","tarefa_base","meio_especifico"];const aH=Object.keys(pD[0]||{});for(const e of eH)if(!aH.includes(e))throw Error(`Cabeçalho "${e}" não achado.`);const iP=[];pD.forEach(r=>{const pN=r.nome_protocolo?.trim(),dS=r.dia?.trim(),bT=r.tarefa_base?.trim()||'-',sM=r.meio_especifico?.trim()||'-';if(!pN||dS==null||dS==='')return;const d=parseInt(dS);if(isNaN(d))return;iP.push({protocolName:pN,day:d,baseTask:bT,specificMedium:sM})});if(iP.length===0){alert("Nenhum protocolo válido.");return}if(confirm(`Importar ${iP.length} passos? (Substitui)`)){protocols=iP;sortDataArrays();saveData();renderProtocolList();alert("Protocolos importados!")}
            } catch (error) {
                console.error("Erro em processProtocolData:", error);
                alert("Erro ao processar CSV de Protocolos: " + error.message);
            }
        }
        function processCollectionData(csvContent){
            try {
                const pD=parseCSV(csvContent);const eH=["levaids","dia","quantidade","experimento"];const aH=Object.keys(pD[0]||{});for(const e of eH)if(!aH.includes(e))throw Error(`Cabeçalho "${e}" não achado.`);const iC=[];pD.forEach(r=>{const lS=r.levaids?.trim(),dS=r.dia?.trim(),qty=r.quantidade?.trim()||'',exp=r.experimento?.trim()||'';if(!lS||dS==null||dS==='')return;const d=parseInt(dS);if(isNaN(d))return;const lIds=lS.split(/[,;]/).map(id=>id.trim()).filter(id=>id!=='');if(lIds.length===0)return;iC.push({levaIds:lIds,day:d,qty,exp})});if(iC.length===0){alert("Nenhuma coleta válida.");return}if(confirm(`Importar ${iC.length} coletas? (Substitui)`)){collections=iC;sortDataArrays();saveData();renderCollectionList();alert("Coletas importadas!")}
            } catch (error) {
                console.error("Erro em processCollectionData:", error);
                alert("Erro ao processar CSV de Coletas: " + error.message);
            }
        }
        function handleJsonFileSelect(event) {
            const file=event.target.files[0];if(!file)return;if(file.type!=='application/json'&&!file.name.toLowerCase().endsWith('.json')){alert('Selecione .json');event.target.value=null;return}
            const reader=new FileReader();reader.onload=(e)=>{try{const iD=JSON.parse(e.target.result);if(!iD||typeof iD!=='object'||!Array.isArray(iD.levas)||!Array.isArray(iD.protocols)||!Array.isArray(iD.collections))throw Error("JSON inválido.");if(confirm("Importar JSON? (Substitui)")){levas=iD.levas;protocols=iD.protocols;collections=iD.collections;sortDataArrays();saveData();renderAllLists();updateCollectionLevaCheckboxes();initializeLastChangeDates();alert("JSON importado!")}}catch(err){alert(`Erro JSON: ${err.message}`)}finally{event.target.value=null}};reader.onerror=()=>{alert('Erro ao ler arquivo.');event.target.value=null};reader.readAsText(file,'UTF-8')
        }

        function daysBetween(d1,d2){const mPD=864e5;const s1=Date.UTC(d1.getUTCFullYear(),d1.getUTCMonth(),d1.getUTCDate());const s2=Date.UTC(d2.getUTCFullYear(),d2.getUTCMonth(),d2.getUTCDate());return Math.floor((s1-s2)/mPD+.00001)}
        function gId(id){return document.getElementById(id)}function qSA(sel){return document.querySelectorAll(sel)}function cE(tag){return document.createElement(tag)}
        function initializeLastChangeDates(){lastMediaChangeDates={};levas.forEach(lv=>{const lS=new Date(lv.startDate+'T00:00:00Z');const iCD=new Date(lS);iCD.setUTCDate(lS.getUTCDate()+3);lastMediaChangeDates[lv.id]=iCD});}

        function getDailyLevaInfo(currentDateUTC,leva,currentLastMediaChangeDates){const lS=new Date(leva.startDate+'T00:00:00Z');const cDSOD=new Date(Date.UTC(currentDateUTC.getUTCFullYear(),currentDateUTC.getUTCMonth(),currentDateUTC.getUTCDate()));if(cDSOD.getTime()<lS.getTime())return null;const dX=daysBetween(cDSOD,lS);const s=protocols.find(p=>p.protocolName===leva.protocolName&&p.day===dX);const bT=s?s.baseTask:'-';const sM=s?s.specificMedium:'-';const cDOW=currentDateUTC.getUTCDay();let fT="-";let fM="-";let pMC=false;const isCT=bT!=='-'&&tarefasCriticasKeywords.some(k=>bT.toLowerCase().includes(k.toLowerCase()));const cTIMC=isCT&&(bT.toLowerCase().includes('transferir')||bT.toLowerCase().includes('plaquear')||sM!=='-');if(dX>=0&&dX<=3){fM=sM;if(dX===0)fT=bT;else{fT=isCT?bT:"Trocar Meio";pMC=true}}else if(dX>=4&&dX<=31){const lCD=currentLastMediaChangeDates&¤tLastMediaChangeDates[leva.id]?currentLastMediaChangeDates[leva.id]:(()=>{const d3=new Date(lS);d3.setUTCDate(lS.getUTCDate()+3);return d3})();const dS=daysBetween(cDSOD,lCD);const nD=new Date(currentDateUTC);nD.setUTCDate(currentDateUTC.getUTCDate()+1);const mC=(dS>=3)||(dS>=2&&nD.getUTCDay()===0);const iDTS=[5,12,19,26].includes(dX);const isPD=preferredChangeDaysOfWeek.includes(cDOW);let sCT=false;if(isCT){fT=bT;fM=sM;if(cTIMC)pMC=true;else if(mC)sCT=true}else if(mC)sCT=true;else if(iDTS){}else if(isPD&&dS>=1)sCT=true;if(sCT){pMC=true;fT="Trocar Meio";if(dX>=25)fM="Meio 3";else if(dX>=18)fM="Meio 2 + FGF2+EGF";else if(dX>=11)fM="Meio 2 + FGF2";else fM="Meio 1"}else if(!pMC&&!isCT){fT=bT;fM=sM;if(dX===4&&fM==='-')fM="Meio 1";if(dX===11&&fM==='-')fM="Meio 2 + FGF2";if(dX===18&&fM==='-')fM="Meio 2 + FGF2+EGF";if(dX===25&&fM==='-')fM="Meio 3"}}else if(dX>=32){const iMCD=preferredChangeDaysOfWeek.includes(cDOW);if(isCT){fT=bT;fM=sM;if(cTIMC)pMC=true}else if(iMCD){pMC=true;fT="Trocar Meio (Manut.)";fM=meioManutencao}else{fT=bT;fM=sM}if(dX===32&&bT!=='-'&&!isCT&&!iMCD){fT=bT;fM=sM}}if(pMC&¤tLastMediaChangeDates&¤tDateUTC){const nDt=new Date(currentDateUTC);if(!currentLastMediaChangeDates[leva.id]||(currentLastMediaChangeDates[leva.id]&¤tLastMediaChangeDates[leva.id].getTime()!==nDt.getTime())){currentLastMediaChangeDates[leva.id]=nDt}}const dCs=collections.filter(c=>c.day===dX&&Array.isArray(c.levaIds)&&c.levaIds.includes(leva.id));if(fT==='-'&&fM==='-'&&dCs.length===0)return null;return{dayX:dX,finalTask:fT,finalMedium:fM,dailyCollections:dCs}}

        function generateCalendar() {
            const sDStr=gId('calendar-start-date').value, eDStr=gId('calendar-end-date').value;
            if(!sDStr||!eDStr||levas.length===0||protocols.length===0){alert("Defina datas e certifique-se de que há levas e protocolos.");return}
            const sD=new Date(sDStr+'T12:00:00Z'), eD=new Date(eDStr+'T12:00:00Z');
            if(isNaN(sD.getTime())||isNaN(eD.getTime())||eD<sD){alert("Datas inválidas ou data final anterior à inicial.");return}
            const today=new Date(); today.setUTCHours(0,0,0,0);
            const outputDiv = gId('calendar-output'), desktopDiv = outputDiv.querySelector('.desktop-calendar'), mobileDiv = outputDiv.querySelector('.mobile-calendar'), placeholder = gId('calendar-placeholder');
            if(placeholder) placeholder.style.display = 'none';
            desktopDiv.innerHTML = ''; mobileDiv.innerHTML = ''; desktopDiv.style.display = 'none'; mobileDiv.style.display = 'none';

            let processLastChanges = JSON.parse(JSON.stringify(lastMediaChangeDates));
            for (const levaId in processLastChanges) { processLastChanges[levaId] = new Date(processLastChanges[levaId]); }

            const isMobileLayout = window.innerWidth <= MOBILE_BREAKPOINT;
            let desktopHTML_Accum = '', mobileHTML_Accum = '';
            let currentMonthDate = new Date(Date.UTC(sD.getUTCFullYear(), sD.getUTCMonth(), 1));

            while (currentMonthDate <= eD) {
                 const month = currentMonthDate.getUTCMonth(), year = currentMonthDate.getUTCFullYear();
                 const monthName = currentMonthDate.toLocaleString('pt-BR',{month:'long',year:'numeric',timeZone:'UTC'});
                 let desktopMonthHTML = `<div class="calendar-month"><h3>${monthName}</h3><table class="calendar-table"><thead><tr>${diasSemana.map(d=>`<th>${d}</th>`).join('')}</tr></thead><tbody>`;
                 let firstDayOfMonthDT = new Date(Date.UTC(year, month, 1));
                 let startingDayOfWeekDT = firstDayOfMonthDT.getUTCDay();
                 let currentDateDT = new Date(Date.UTC(year, month, 1 - startingDayOfWeekDT));
                 let rowsGeneratedForMonth = 0;
                 for (let week = 0; week < 6; week++) {
                     if (currentDateDT.getUTCMonth() !== month && currentDateDT > eD && week > 0 && rowsGeneratedForMonth > 0) break;
                     desktopMonthHTML += '<tr>';
                     let cellsInRowAreAllPastEndDate = true;
                     for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
                        const dOM=currentDateDT.getUTCDate(), cMCk=currentDateDT.getUTCMonth(), cY=currentDateDT.getUTCFullYear();
                        const isCurrentDisplayMonth = cMCk === month && cY === year;
                        const isWeekend = currentDateDT.getUTCDay() === 0 || currentDateDT.getUTCDay() === 6;
                        const isToday = (new Date(currentDateDT).setUTCHours(0,0,0,0)) === today.getTime();
                        let cellClasses = [];
                        if(!isCurrentDisplayMonth) cellClasses.push('other-month');
                        else { if(isWeekend)cellClasses.push('weekend'); if(isToday)cellClasses.push('today'); if(currentDateDT<=eD)cellsInRowAreAllPastEndDate=false; }
                        desktopMonthHTML += `<td class="${cellClasses.join(' ')}">`;
                        if (isCurrentDisplayMonth) {
                            if (currentDateDT >= sD && currentDateDT <= eD) {
                                desktopMonthHTML += `<span class="day-number">${dOM}</span><div>`; const cD4Diff = new Date(currentDateDT);
                                levas.forEach(lv => { const dI = getDailyLevaInfo(cD4Diff, lv, processLastChanges);
                                    if(dI){const{dayX,finalTask,finalMedium,dailyCollections}=dI;let lH=`<div class="leva-entry" style="border-left-color:${lv.color};" title="Linhas:${lv.cellLines||'N/A'}"><div class="leva-info">${lv.id} DIA ${dayX}</div>${finalTask!=='-'?`<div class="leva-task">${finalTask}</div>`:''}${finalMedium!=='-'?`<div class="leva-medium">${finalMedium}</div>`:''}`;if(dailyCollections&&dailyCollections.length>0){dailyCollections.forEach(cl=>{if(cl)lH+=`<div class="collection-info-inline" title="Coleta p/${cl.levaIds?.join(',')||'?'}: ${cl.qty||'N/A'}"><span class="collection-icon">C</span> ${cl.exp||'Coleta'}: ${cl.qty||'N/A'}</div>`});}lH+=`</div>`;desktopMonthHTML+=lH;} });
                                desktopMonthHTML += '</div>';
                            } else { desktopMonthHTML += `<span class="day-number">${dOM}</span>`; }
                        }
                        desktopMonthHTML += '</td>'; currentDateDT.setUTCDate(currentDateDT.getUTCDate() + 1);
                     }
                     desktopMonthHTML += '</tr>'; rowsGeneratedForMonth++;
                     if (cellsInRowAreAllPastEndDate && currentDateDT > eD) break;
                 }
                 desktopMonthHTML+='</tbody></table></div>'; desktopHTML_Accum+=desktopMonthHTML;
                 let mobileMonthHTML = `<div class="calendar-month"><h3>${monthName}</h3>`;
                 let currentDateMB = new Date(Date.UTC(year, month, 1)), monthEndDateMB = new Date(Date.UTC(year, month + 1, 0));
                 while(currentDateMB <= monthEndDateMB) {
                     if (currentDateMB>=sD && currentDateMB<=eD) {
                         const cDoW=currentDateMB.getUTCDay(),isWkMB=cDoW===0||cDoW===6;const cDUT0MB=new Date(currentDateMB);cDUT0MB.setUTCHours(0,0,0,0);const isTdMB=cDUT0MB.getTime()===today.getTime();
                         let dHCls=['mobile-day-header'];if(isWkMB)dHCls.push('weekend');if(isTdMB)dHCls.push('today');
                         let lvsCHTM = ''; let hasCnt=false; const cD4DiffMB=new Date(currentDateMB);
                         levas.forEach(lv => {const dI=getDailyLevaInfo(cD4DiffMB,lv,processLastChanges);
                             if(dI){hasCnt=true;const{dayX,finalTask,finalMedium,dailyCollections}=dI;lvsCHTM+=`<div class="mobile-leva-entry" style="border-left-color:${lv.color};" title="Linhas:${lv.cellLines||'N/A'}"><div class="leva-info">${lv.id} DIA ${dayX}</div>`; if(finalTask!=='-')lvsCHTM+=`<div class="leva-task">${finalTask}</div>`;if(finalMedium!=='-')lvsCHTM+=`<div class="leva-medium">${finalMedium}</div>`;if(dailyCollections&&dailyCollections.length>0){dailyCollections.forEach(cl=>{if(cl)lvsCHTM+=`<div class="collection-info-inline" title="Coleta p/${cl.levaIds?.join(',')||'?'}: ${cl.qty||'N/A'}"><span class="collection-icon">C</span> ${cl.exp||'Coleta'}: ${cl.qty||'N/A'}</div>`});}lvsCHTM+=`</div>`;} });
                         if(hasCnt)mobileMonthHTML+=`<div class="mobile-day-row"><div class="${dHCls.join(' ')}">${currentDateMB.toLocaleDateString('pt-BR',{day:'numeric',month:'short',timeZone:'UTC'})} (${diasSemana[cDoW]})</div><div class="mobile-levas-container">${lvsCHTM}</div></div>`;
                     }
                     currentDateMB.setUTCDate(currentDateMB.getUTCDate()+1);
                 }
                 mobileMonthHTML+='</div>'; mobileHTML_Accum+=mobileHTML_Accum;
                 currentMonthDate.setUTCMonth(currentMonthDate.getUTCMonth()+1);
            }
            desktopDiv.innerHTML = desktopHTML_Accum; mobileDiv.innerHTML = mobileHTML_Accum;
            if(isMobileLayout) { mobileDiv.style.display = 'block'; desktopDiv.style.display = 'none'; }
            else { desktopDiv.style.display = 'block'; mobileDiv.style.display = 'none'; }
        }

        function showTasksTodayInNewTab() {
            const today = new Date();
            const todayUTC = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate(), 12, 0, 0));
            const todayStr = today.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            let tasksFound = false;

            let tempLastChanges = JSON.parse(JSON.stringify(lastMediaChangeDates));
            for (const levaId in tempLastChanges) { tempLastChanges[levaId] = new Date(tempLastChanges[levaId]); }

            let overallStartDate = null;
            if (levas.length > 0) { const startDates = levas.map(l => new Date(l.startDate + 'T00:00:00Z').getTime()); if (startDates.length > 0) { overallStartDate = new Date(Math.min(...startDates));} }

            if (overallStartDate && overallStartDate < todayUTC) {
                let currentSimDate = new Date(overallStartDate);
                while (currentSimDate < todayUTC) {
                    levas.forEach(lv => { const levaStartDate = new Date(lv.startDate + 'T00:00:00Z'); if (currentSimDate >= levaStartDate) { getDailyLevaInfo(currentSimDate, lv, tempLastChanges); } });
                    currentSimDate.setUTCDate(currentSimDate.getUTCDate() + 1);
                }
            }

            let htmlContent = `<!DOCTYPE html><html lang="pt-BR"><head><meta charset="UTF-8"><title>Tarefas de Hoje - ${todayStr}</title>
            <style> body { font-family:sans-serif;margin:20px;line-height:1.6;font-size:14px } .leva-section { border:1px solid #ccc;border-radius:8px;padding:15px;margin-bottom:15px;page-break-inside:avoid } .leva-section h2 { margin:0 0 10px 0;font-size:1.3em;border-bottom:1px solid #eee;padding-bottom:8px;color:#333;display:flex;align-items:center } .leva-color-swatch { display:inline-block;width:18px;height:18px;border:1px solid #777;margin-right:10px;vertical-align:middle;flex-shrink:0;border-radius:3px } .leva-title-text { flex-grow:1 } .task-item { margin-bottom:6px } .task-label { font-weight:bold;color:#555 } .collection-item { color:#28a745;margin-top:10px;border-top:1px dashed #ccc;padding-top:8px;font-weight:bold } .collection-details { font-weight:normal;color:#333;margin-left:5px } .no-tasks { font-style:italic;color:#666 } hr { border:0;border-top:1px dashed #ccc;margin:15px 0 }
                @media print { button{display:none} body{margin:.5in;font-size:11pt} .leva-section{border:1px solid #aaa;box-shadow:none} h1{font-size:16pt} h2{font-size:13pt} }
            </style></head><body><h1>Tarefas para ${todayStr}</h1><button onclick="window.print()">Imprimir</button><hr>`;

            levas.forEach(leva => {
                const levaStartDate = new Date(leva.startDate + 'T00:00:00Z');
                if (levaStartDate > todayUTC && levaStartDate.getTime() !== todayUTC.getTime()) { return; }
                const dailyInfo = getDailyLevaInfo(todayUTC, leva, tempLastChanges);
                if (dailyInfo) {
                    tasksFound = true; const { dayX, finalTask, finalMedium, dailyCollections } = dailyInfo;
                    htmlContent += `<div class="leva-section"><h2><span class="leva-color-swatch" style="background-color:${leva.color};"></span><span class="leva-title-text">Leva ${leva.id} (Dia ${dayX}) <small>(${leva.cellLines||'N/A'})</small></span></h2>`;
                    if (finalTask !== '-') htmlContent += `<div class="task-item"><span class="task-label">Tarefa:</span> ${finalTask}</div>`;
                    if (finalMedium !== '-') htmlContent += `<div class="task-item"><span class="task-label">Meio:</span> ${finalMedium}</div>`;
                    if(dailyCollections && dailyCollections.length > 0) { dailyCollections.forEach(col => { if(col) { htmlContent += `<div class="collection-item"><span class="task-label">Coleta:</span><span class="collection-details">${col.exp||'Coleta'}: ${col.qty||'N/A'}</span></div>`; } }); }
                    htmlContent += `</div>`;
                }
            });
            if (!tasksFound) { htmlContent += `<p class="no-tasks">Nenhuma tarefa ou coleta agendada para hoje.</p>`;}
            htmlContent += `</body></html>`;
            const newTab = window.open('', '_blank');
            if (newTab) { newTab.document.open(); newTab.document.write(htmlContent); newTab.document.close(); newTab.focus(); }
            else { alert('Não foi possível abrir a nova aba. Verifique pop-ups.'); }
        }

        function exportDataJson() { const dE={levas,protocols,collections}; const jS=JSON.stringify(dE,null,2); downloadFile('cronograma_organoides_dados.json',jS,'application/json'); }
        function exportScheduleCsv() {
             const sDStr=gId('calendar-start-date').value,eDStr=gId('calendar-end-date').value; if(!sDStr||!eDStr){alert("Defina datas para CSV.");return}
             const sD=new Date(sDStr+'T12:00:00Z'),eD=new Date(eDStr+'T12:00:00Z'); if(isNaN(sD.getTime())||isNaN(eD.getTime())||eD<sD){alert("Datas CSV inválidas.");return}
             gId('csv-processing').style.display='inline';
             setTimeout(()=>{
                 const hdrs=['Data','Dia_Semana','ID_Leva','Dia_X','Tipo','Descricao','Detalhes','Linhas_Celulares']; let csvCnt='\uFEFF'+hdrs.map(escapeCsvField).join(',')+'\n';
                 let csvSimulatedLastChanges = JSON.parse(JSON.stringify(lastMediaChangeDates));
                 for (const levaId in csvSimulatedLastChanges) { csvSimulatedLastChanges[levaId] = new Date(csvSimulatedLastChanges[levaId]); }

                 let cD=new Date(sD);
                 while(cD<=eD){ const dS=cD.toLocaleDateString('pt-BR',{timeZone:'UTC'}),dOWS=diasSemana[cD.getUTCDay()];
                     levas.forEach(lv=>{ const lS=new Date(lv.startDate+'T00:00:00Z');
                         if(cD>=lS){ const dI=getDailyLevaInfo(cD,lv,csvSimulatedLastChanges);
                             if(dI){const{dayX,finalTask,finalMedium,dailyCollections}=dI; if(finalTask!=='-'||finalMedium!=='-'){csvCnt+=[dS,dOWS,lv.id,dayX,'Atividade',finalTask,finalMedium,lv.cellLines||''].map(escapeCsvField).join(',')+'\n'} dailyCollections.forEach(cl=>{csvCnt+=[dS,dOWS,lv.id,dayX,'Coleta',cl.exp||'Coleta',cl.qty||'N/A',lv.cellLines||''].map(escapeCsvField).join(',')+'\n'}) }} });
                     cD.setUTCDate(cD.getUTCDate()+1);
                 }
                 downloadFile(`cronograma_${sDStr}_a_${eDS}.csv`,csvCnt,'text/csv'); gId('csv-processing').style.display='none';
             },50);
         }

        function getDefaultProtocols() { const dPN="Trujillo_200"; const pS=[ {protocolName:dPN,day:0,baseTask:'AGREGAR',specificMedium:'E8 + 20uM Rocki'}, {protocolName:dPN,day:1,baseTask:'Indução Neural D1 (+100uL)',specificMedium:'E8 + 2uM Dorso + 20uM SB'}, {protocolName:dPN,day:2,baseTask:'Indução Neural D2 (- + 150uL)',specificMedium:'E8 + 1uM Dorso + 10uM SB'}, {protocolName:dPN,day:3,baseTask:'Indução Neural D3 (- + 150uL)',specificMedium:'E8 + 1uM Dorso + 10uM SB'}, {protocolName:dPN,day:4,baseTask:'Transferir ~10 CtO/well // Início Meio 1',specificMedium:'Meio 1'}, {protocolName:dPN,day:5,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:6,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:7,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:8,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:9,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:10,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:11,baseTask:'Plaquear 5 CtO/Well / Início Meio 2+FGF2',specificMedium:'Meio 2 + FGF2'}, {protocolName:dPN,day:12,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:13,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:14,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:15,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:16,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:17,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:18,baseTask:'Adicionar EGF / Início Meio 2+FGF2+EGF',specificMedium:'Meio 2 + FGF2+EGF'}, {protocolName:dPN,day:19,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:20,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:21,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:22,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:23,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:24,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:25,baseTask:'Início Meio 3',specificMedium:'Meio 3'}, {protocolName:dPN,day:26,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:27,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:28,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:29,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:30,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:31,baseTask:'-',specificMedium:'-'}, {protocolName:dPN,day:32,baseTask:'Organoides Formados! / Manutenção',specificMedium:meioManutencao}, ...Array.from({length:61},(_,i)=>({protocolName:dPN,day:33+i,baseTask:'-',specificMedium:'-'})) ]; return pS; }
        window.onload = () => {
             loadData();
             if (levas.length === 0 && localStorage.getItem(LEVAS_KEY) === null) {
                console.log("Nenhuma leva salva encontrada, adicionando exemplos.");
                levas = [
                    { id: 'L2', startDate: '2024-07-25', color: 'pink', protocolName: 'Trujillo_200', cellLines: '14vz, 14T' },
                    { id: 'L3', startDate: '2024-07-26', color: 'lightgreen', protocolName: 'Trujillo_200', cellLines: '7vz, 7T' },
                    { id: 'L4', startDate: '2024-08-03', color: 'lightblue', protocolName: 'Trujillo_200', cellLines: '8vz, 8T' },
                    { id: 'L5', startDate: '2024-07-22', color: 'orange', protocolName: 'Trujillo_200', cellLines: 'L5 cells' },
                    { id: 'L6', startDate: '2024-06-25', color: 'cyan', protocolName: 'Trujillo_200', cellLines: 'L6 cells' }
                ];
                 sortDataArrays(); saveData(); renderAllLists(); updateCollectionLevaCheckboxes();
             }
             initializeLastChangeDates();

             const tD = new Date(); const fDCM = new Date(tD.getFullYear(),tD.getMonth(),1); const lDNM = new Date(tD.getFullYear(),tD.getMonth()+2,0);
             const fDt = (d) => d.toISOString().split('T')[0];
             if(!gId('calendar-start-date').value) gId('calendar-start-date').value = fDt(fDCM);
             if(!gId('calendar-end-date').value) gId('calendar-end-date').value = fDt(lDNM);
         };
    </script>
</body>
</html>
